<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Inventario PDA</title>
    
    <!-- Estilos incrustados para máxima compatibilidad con PDA. -->
    <style>
        /* Aplicar box-sizing globalmente para asegurar que el padding y border no causen desbordamiento */
        * {
            box-sizing: border-box; 
        }

        /* Variables de Color */
        :root {
            --theme-color: #ed5224; /* Nuevo color: Naranja/Rojo */
            --theme-color-rgb: 237, 82, 36;
        }

        /* Estilos Base y Adaptación General */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
            min-height: 100vh;
            display: flex;
            align-items: center; 
            justify-content: center;
            padding: 0.5rem; 
            margin: 0; /* Asegurar que no hay margen extra en el body */
        }
        #appContainer {
            width: 100%;
            max-width: 448px; 
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; 
            padding: 1rem;
            margin-top: 1rem; 
            margin-bottom: 1rem; /* Margen para centrar verticalmente mejor */
        }

        /* Títulos y Metadatos (Más compactos) */
        h1 {
            font-size: 1.25rem; 
            font-weight: 700;
            text-align: center;
            color: var(--theme-color);
            margin-bottom: 0.5rem; 
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0; 
        }
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 0.75rem; 
        }
        
        /* Input de Escaneo (El elemento central) */
        #scannerInput {
            width: 100%;
            padding: 0.75rem; 
            text-align: center;
            font-size: 1rem; 
            font-family: monospace;
            letter-spacing: 0.05em;
            background-color: #fff;
            border: 2px solid var(--theme-color);
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            outline: none;
            transition: all 0.15s;
            caret-color: var(--theme-color);
        }
        #scannerInput:focus {
             border-color: var(--theme-color);
             box-shadow: 0 0 0 3px rgba(var(--theme-color-rgb), 0.3);
        }

        /* Área de Resultados (Más compacta y definida) */
        #resultArea {
            min-height: 80px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
            margin-bottom: 0.75rem;
        }
        
        /* Estilos de mensajes */
        .text-status {
            font-size: 1rem; 
            font-weight: 600;
        }
        .text-code {
            font-size: 0.875rem; 
            color: inherit;
            margin-top: 0.25rem;
        }

        /* Clases de Colores Dinámicos */
        .bg-gray-initial { 
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1; 
            color: #475569;
        }
        .bg-loading { 
            background-color: #fef3c7;
            border: 1px solid #fbbf24; 
            color: #92400e; 
        }
        .bg-success { 
            background-color: #10b981; 
            color: #fff; 
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
            border: none;
        }
        .bg-error { 
            background-color: #ef4444; 
            color: #fff; 
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
            border: none;
        }
    </style>
</head>
<body class="p-2">

    <!-- Contenedor Principal -->
    <div id="appContainer">
        <h1 class="text-xl font-bold">
            VALIDADOR DE UBICACIONES
        </h1>
        <p class="subtitle">Escanea una ubicación o ingresa el código.</p>

        <!-- Área de Escaneo y Resultados (Compacta) -->
        <div id="resultArea" class="bg-gray-initial">
            <p id="statusMessage" class="text-status">Listo para escanear...</p>
            <p id="scannedCodeDisplay" class="text-code"></p>
        </div>

        <!-- Input de Escaneo (Máxima prioridad en enfoque) -->
        <div class="mb-2">
            <label for="scannerInput" class="block text-sm font-medium text-gray-700 mb-1 text-center">
                CÓDIGO:
            </label>
            <input 
                type="text" 
                id="scannerInput" 
                placeholder=">>> Esperando escaneo <<<" 
                autofocus 
                autocomplete="off"
            >
        </div>
        
        <!-- El mensaje de error ahora solo aparece si la carga falla -->
        <p class="text-xs mt-2 text-center" id="errorMsg" style="display: none; color: #ef4444;">
            ⚠️ ERROR CRÍTICO: No se pudo conectar a la base de datos de Google Sheets. Verifica la URL.
        </p>
    </div>

    <script>
        // --- CONFIGURACIÓN CRÍTICA: BASE DE DATOS CSV ---
        // Se utiliza la URL proporcionada.
        const GOOGLE_SHEET_JSON_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT46zfWFbNyt8D3W4xFmFJIa2O3VskJc3YieppeELvYh8h_R6FpGG9YW4vZZvtgkug2bglw_eGJQ55O/pub?output=csv'; 
        // -------------------------------------------------------------

        // Referencias a elementos del DOM
        const scannerInput = document.getElementById('scannerInput');
        const resultArea = document.getElementById('resultArea');
        const statusMessage = document.getElementById('statusMessage');
        const scannedCodeDisplay = document.getElementById('scannedCodeDisplay');
        const errorMsg = document.getElementById('errorMsg');

        // Constantes de Tiempo de Alerta
        const SUCCESS_TIMEOUT = 3000; // 3 segundos
        const ERROR_TIMEOUT = 1500;  // 1.5 segundos

        // Estado de la base de datos
        let dbCodes = new Set();
        let isDbLoaded = false;
        let scanTimeout; 
        
        // --- FUNCIÓN DE ENFOQUE AGRESIVO (Mantiene el input listo) ---
        function keepFocus() {
            setTimeout(() => {
                scannerInput.focus();
            }, 0); 
        }

        // --- FUNCIONES DE FEEDBACK (Sonidos y Vibración) ---
        
        function playSuccessSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.7, audioCtx.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); 
                oscillator.stop(audioCtx.currentTime + 0.15);
            } catch (e) {
                console.warn("Error al reproducir sonido de éxito:", e);
            }
        }

        function playErrorSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) {
                console.warn("Error al reproducir sonido de error:", e);
            }
        }
        
        function vibrateError() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        // --- MANEJO DE LA BASE DE DATOS (GOOGLE SHEETS CSV) ---

        async function loadDatabase() {
            // Se elimina la verificación estricta. Ahora solo verificamos que la URL no esté vacía.
            if (!GOOGLE_SHEET_JSON_URL) {
                 errorMsg.style.display = 'block';
                 statusMessage.textContent = 'ERROR: URL de base de datos no configurada.';
                 resultArea.className = 'bg-error';
                 isDbLoaded = false;
                 return;
            }
            
            errorMsg.style.display = 'none';
            statusMessage.textContent = 'Cargando base de datos...';
            resultArea.className = 'bg-loading'; 

            try {
                const response = await fetch(GOOGLE_SHEET_JSON_URL);
                
                // Si la respuesta es 404 o similar, indicamos el error de forma explícita
                if (!response.ok) {
                     throw new Error(`Error HTTP ${response.status}: No se pudo acceder a la hoja de cálculo. Asegúrate de que esté "Publicada en la web".`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                
                dbCodes.clear();
                
                lines.slice(1).forEach(line => { 
                    const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
                    const code = parts[0]?.replace(/"/g, '').trim(); 
                    
                    if (code) {
                        dbCodes.add(String(code).toUpperCase());
                    }
                });

                isDbLoaded = true;
                statusMessage.textContent = `Base de datos CSV cargada: ${dbCodes.size} códigos`;
                resultArea.className = 'bg-gray-initial'; 
                
            } catch (error) {
                console.error("Error al cargar la base de datos CSV:", error);
                statusMessage.textContent = 'ERROR: No se pudo cargar la base de datos.';
                errorMsg.textContent = error.message || '⚠️ ERROR CRÍTICO: No se pudo conectar a la base de datos de Google Sheets. Verifica la URL y la publicación.';
                errorMsg.style.display = 'block';
                resultArea.className = 'bg-error'; 
                isDbLoaded = false;
            }
            
            keepFocus();
        }

        // --- LÓGICA DE ESCANEO Y VALIDACIÓN ---

        function processScan() {
            const scannedCode = scannerInput.value.trim().toUpperCase();
            
            if (!scannedCode) {
                keepFocus();
                return;
            }

            // Muestra el código escaneado
            scannedCodeDisplay.textContent = `${scannedCode}`;
            
            if (!isDbLoaded) {
                statusMessage.textContent = 'Base de datos no disponible.';
                resultArea.className = 'bg-error'; 
                playErrorSound();
                vibrateError();
                return;
            }

            // VALIDACIÓN
            let timeoutDuration;
            if (dbCodes.has(scannedCode)) {
                // CÓDIGO ENCONTRADO (ÉXITO)
                resultArea.className = 'bg-success'; 
                statusMessage.textContent = '✅ CÓDIGO ENCONTRADO';
                playSuccessSound();
                timeoutDuration = SUCCESS_TIMEOUT;
            } else {
                // CÓDIGO NO ENCONTRADO (ERROR)
                resultArea.className = 'bg-error'; 
                statusMessage.textContent = '❌ CÓDIGO NO ENCONTRADO';
                playErrorSound();
                vibrateError();
                timeoutDuration = ERROR_TIMEOUT;
            }

            // Vuelve al estado listo
            setTimeout(() => {
                resultArea.className = 'bg-gray-initial'; 
                statusMessage.textContent = 'Listo para escanear...';
                scannerInput.value = ''; 
                scannedCodeDisplay.textContent = '';
                keepFocus(); 
            }, timeoutDuration); 
        }
        
        // --- SOLUCIÓN PDA: DETECCIÓN POR EVENTO 'INPUT' Y TEMPORIZADOR ---
        
        function handleScanInput() {
            clearTimeout(scanTimeout);

            // Se aumenta el retraso a 500ms (0.5s) para permitir una escritura manual
            // más cómoda. La validación solo se activa después de una pausa considerable.
            scanTimeout = setTimeout(() => {
                if (scannerInput.value.length > 0) {
                    processScan();
                }
            }, 500); // Retraso ajustado para escritura manual.
        }

        // --- INICIALIZACIÓN ---
        
        window.onload = () => {
            loadDatabase();
            
            // 1. Escuchar el cambio de contenido (escaneo rápido).
            scannerInput.addEventListener('input', handleScanInput);

            // 2. Fallback: Mantener el keydown para usuarios de PC que usan ENTER manual.
            scannerInput.addEventListener('keydown', (event) => {
                 if (event.key === 'Enter') {
                    event.preventDefault(); 
                    clearTimeout(scanTimeout); 
                    processScan();
                }
            });
            
            // 3. Mantener el foco activo (Solución PDA)
            document.body.addEventListener('click', keepFocus);
            document.body.addEventListener('touchstart', keepFocus);
            scannerInput.addEventListener('blur', keepFocus); 
            
            keepFocus(); // Foco inicial
        };

        window.onresize = keepFocus;
        
    </script>
</body>
</html>
