<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n WMS</title>
    <style>
        :root {
            --primary: #ed5224;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --text: #333;
            --bg: #f7f7f7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); 
            color: var(--text);
        }

        /* === DASHBOARD === */
        #dashboard { max-width: 1100px; margin: 0 auto; padding: 30px 20px; }
        .dash-header { text-align: center; margin-bottom: 40px; }
        .dash-header h1 { font-size: 2.2em; color: var(--primary); margin-bottom: 8px; }
        
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .dash-card-icon { font-size: 2.5em; margin-bottom: 10px; }
        .dash-card-value { font-size: 2em; font-weight: 700; color: var(--primary); margin-top: 5px; }
        
        .status-grid { display: grid; gap: 12px; margin-bottom: 20px; }
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 6px; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: var(--success); }
        .status-error { background: var(--error); }
        
        .btn { padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 1.1em; transition: all 0.2s; width: 100%; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 1.4em; padding: 20px; }
        .btn-google { background: #4285F4; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        /* === VALIDATION SCREEN === */
        #validation { display: none; min-height: 100vh; }
        .container { display: flex; }
        .sidebar { width: 260px; background: #333; color: white; padding: 18px; overflow-y: auto; }
        .main-content { flex: 1; padding: 15px; max-width: 1400px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: var(--primary); font-size: 1.6em; }
        
        .card { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Progress Card */
        .progress-card { 
            background: linear-gradient(135deg, #ffa07a 0%, #ff8a52 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-obc-name { font-size: 1.2em; font-weight: 700; }
        .progress-percentage { font-size: 2em; font-weight: 800; }
        .progress-counts { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .progress-count-item { text-align: center; }
        .progress-count-number { font-size: 1.4em; font-weight: 700; }
        .progress-count-label { font-size: 0.7em; opacity: 0.85; }
        .progress-bar-container { background: rgba(0,0,0,0.25); height: 10px; border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #fff, #ffd966); transition: width 0.5s; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        /* Inputs en l√≠nea */
        .inline-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .scanner-input { font-size: 1.6em !important; text-transform: uppercase; font-weight: bold; text-align: center; background: #fff5ed !important; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .stat-box { text-align: center; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 2em; font-weight: 700; margin-top: 5px; }
        .stat-ok { background: #e8f5e9; border: 2px solid var(--success); color: var(--success); }
        .stat-error { background: #ffebee; border: 2px solid var(--error); color: var(--error); }
        
        /* Logs con numeraci√≥n */
        .logs-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .log-list { max-height: 350px; overflow-y: auto; list-style: none; background: #fafafa; padding: 10px; border-radius: 8px; counter-reset: log-counter; }
        .log-item { display: flex; gap: 8px; padding: 8px; margin-bottom: 6px; background: white; border-radius: 4px; border-left: 4px solid; }
        .log-item::before { content: counter(log-counter) "."; counter-increment: log-counter; font-weight: 700; min-width: 25px; }
        .log-ok { border-color: var(--success); }
        .log-ok::before { color: var(--success); }
        .log-reject { border-color: var(--error); }
        .log-reject::before { color: var(--error); }
        .log-info { flex: 1; }
        .log-code { font-weight: 600; }
        
        /* Tabs */
        .tab-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tab { padding: 8px 15px; cursor: pointer; border: 2px solid #ddd; border-radius: 6px; background: white; font-weight: 600; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab.new-tab { background: linear-gradient(135deg, #ffb399, #ff9d7a); color: white; }
        
        /* Notificaciones */
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px; }
        .notification { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-left: 4px solid; animation: slideIn 0.3s; }
        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .popup-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .popup-header { font-size: 1.4em; font-weight: 700; margin-bottom: 15px; }
        .popup-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        
        /* Resumen Module */
        #resumen-module { display: none; }
        .search-bar { padding: 12px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 100%; font-size: 1em; }
        .resumen-table { width: 100%; border-collapse: collapse; background: white; }
        .resumen-table th, .resumen-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .resumen-table th { background: #f5f5f5; font-weight: 700; }
        
        /* Faltantes Module */
        #faltantes-module { display: none; }
        .faltantes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 500px; overflow-y: auto; }
        .faltante-item { padding: 12px; border-radius: 6px; text-align: center; font-size: 0.85em; font-weight: 600; }
        .faltante-ok { background: #e8f5e9; color: var(--success); }
        .faltante-pending { background: #ffebee; color: var(--error); }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; }
            .inline-inputs { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notifications"></div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <div class="dash-header">
            <h1>üè≠ Sistema de Validaci√≥n WMS</h1>
            <p>Warehouse Management System</p>
        </div>

        <div class="dash-grid">
            <div class="dash-card">
                <div class="dash-card-icon">üì¶</div>
                <div>√ìrdenes de Hoy</div>
                <div class="dash-card-value" id="dash-orders">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-icon">‚úÖ</div>
                <div>Cajas Validadas</div>
                <div class="dash-card-value" id="dash-validated">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-icon">üìä</div>
                <div>C√≥digos en BD</div>
                <div class="dash-card-value" id="dash-bd">0</div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px; color: var(--primary);">Estado del Sistema</h2>
            <div class="status-grid">
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-conn"></div>
                        Conexi√≥n Google Sheets
                    </div>
                    <span id="conn-label">Desconectado</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-bd"></div>
                        Base de Datos
                    </div>
                    <span id="bd-label">No cargada</span>
                </div>
            </div>
            <button id="connect-btn" class="btn btn-google" onclick="handleAuthClick()">üîó Conectar con Google Sheets</button>
            <button id="load-bd-btn" class="btn btn-secondary" onclick="loadDatabase()" style="display:none; margin-top:10px;">üìä Cargar Base de Datos</button>
        </div>

        <button id="start-btn" class="btn btn-success" onclick="startValidation()" disabled style="margin-top: 20px;">
            üöÄ Iniciar Validaci√≥n
        </button>
    </div>

    <!-- VALIDATION SCREEN -->
    <div id="validation">
        <div class="container">
            <div class="sidebar">
                <h2 style="color: var(--primary); margin-bottom: 15px;">WMS Validator</h2>
                <button class="btn btn-primary" onclick="returnToDashboard()" style="margin-bottom: 15px;">‚Üê Dashboard</button>
                <button class="btn btn-secondary" onclick="showResumen()" style="margin-bottom: 15px;">üìã Resumen</button>
                <button class="btn btn-secondary" onclick="showFaltantes()" style="margin-bottom: 15px;">üîç Faltantes</button>
                <hr style="border-color: #555; margin: 15px 0;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.5em; font-weight: 700; color: var(--primary);" id="bd-count-sidebar">0</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">c√≥digos en BD</div>
                </div>
                <div id="obc-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <div class="main-content">
                <div class="header">
                    <h1>üîç Validaci√≥n de Cajas</h1>
                    <button class="btn btn-secondary" onclick="exportData()">üì• Exportar CSV</button>
                </div>

                <div id="tab-bar" class="tab-bar"></div>

                <div class="progress-card">
                    <div class="progress-header">
                        <div class="progress-obc-name" id="prog-obc">-</div>
                        <div class="progress-percentage" id="prog-pct">0%</div>
                    </div>
                    <div class="progress-counts">
                        <div class="progress-count-item">
                            <div class="progress-count-number" id="prog-scan">0</div>
                            <div class="progress-count-label">Escaneadas</div>
                        </div>
                        <div class="progress-count-item">
                            <div class="progress-count-number" id="prog-total">0</div>
                            <div class="progress-count-label">Total</div>
                        </div>
                        <div class="progress-count-item">
                            <div class="progress-count-number" id="prog-rest">0</div>
                            <div class="progress-count-label">Faltantes</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="prog-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="inline-inputs">
                        <div class="input-group">
                            <label>üë§ Usuario:</label>
                            <select id="user-select" onchange="updateState()"></select>
                        </div>
                        <div class="input-group">
                            <label>üì¶ Orden Activa:</label>
                            <input type="text" id="obc-display" disabled>
                        </div>
                        <div class="input-group">
                            <label>üìç Ubicaci√≥n Global:</label>
                            <input type="text" id="location-input" placeholder="Ej: PLEC123" onchange="updateState()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label style="font-size: 1.1em; color: var(--primary);">üì∑ ESCANEAR C√ìDIGO:</label>
                        <input type="text" id="scanner" class="scanner-input" placeholder="Escanea aqu√≠..." autofocus>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-box stat-ok">
                        VALIDADAS
                        <div class="stat-number" id="stat-ok">0</div>
                    </div>
                    <div class="stat-box stat-error">
                        RECHAZADAS
                        <div class="stat-number" id="stat-error">0</div>
                    </div>
                </div>

                <div class="logs-container">
                    <div class="card">
                        <h3>‚úÖ Validaciones OK</h3>
                        <ul id="log-ok" class="log-list"></ul>
                    </div>
                    <div class="card">
                        <h3>‚ùå Rechazos</h3>
                        <ul id="log-reject" class="log-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESUMEN MODULE -->
    <div id="resumen-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üìã Resumen de √ìrdenes</h1>
                    <button class="btn btn-secondary" onclick="hideResumen()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <input type="text" id="search-resumen" class="search-bar" placeholder="üîç Buscar orden..." oninput="filterResumen()">
                    <div style="overflow-x: auto;">
                        <table class="resumen-table">
                            <thead>
                                <tr>
                                    <th>Orden</th>
                                    <th>Total</th>
                                    <th>Validadas</th>
                                    <th>Progreso</th>
                                    <th>Destino</th>
                                    <th>Horario</th>
                                </tr>
                            </thead>
                            <tbody id="resumen-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FALTANTES MODULE -->
    <div id="faltantes-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîç C√≥digos Faltantes</h1>
                    <button class="btn btn-secondary" onclick="hideFaltantes()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <h3 id="faltantes-title">Orden: -</h3>
                    <p style="margin-bottom: 15px;">‚úÖ Validados | ‚ùå Faltantes</p>
                    <div class="faltantes-grid" id="faltantes-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUPS -->
    <div id="popup-error" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--error);">‚ùå C√ìDIGO RECHAZADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="err-code"></span><br>
                <strong>Motivo:</strong> <span id="err-reason" style="color: var(--error);"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('error')">Continuar</button>
            </div>
        </div>
    </div>

    <div id="popup-dup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è DUPLICADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="dup-code"></span><br>
                <strong>Validado:</strong> <span id="dup-when"></span><br>
                <strong>Usuario:</strong> <span id="dup-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('dup')">Ignorar</button>
                <button class="btn btn-primary" onclick="forceDuplicate()">Forzar con Nota</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        const CLIENT_ID = '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com';
        const SPREADSHEET_BD = '1nKqd0mqEkZ1l8wqW83_d5fyarp5BKbV1nXSNJBk4-Ck';
        const SPREADSHEET_WRITE = '1gU5yDb0R4_Mf1fE-lOA7vwYmTUBR0wV7EPGg5zUt2Xo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        let USERS = ['MIGUEL', 'PEDRO', 'ALEJANDRO', 'ESMERALDA', 'KATERYNE'];
        let BD_CODES = new Set();
        let OBC_MAP = new Map();
        let OBC_TOTALS = new Map();
        let OBC_INFO = new Map();
        let STATE = {
            activeOBC: 'OBC_DEFAULT',
            tabs: {
                'OBC_DEFAULT': { user: 'MIGUEL', location: '', validations: [], rejections: [] }
            }
        };
        let TOKEN_CLIENT, audioCtx;
        let lastScanned = null;

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            initAudio();
            await loadFromStorage();
            setupListeners();
            populateUsers();
            renderValidation();
            gapi.load('client', initGAPI);
        });

        function initAudio() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.addEventListener('click', () => audioCtx.state === 'suspended' && audioCtx.resume(), { once: true });
            } catch (e) {}
        }

        async function initGAPI() {
            try {
                await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (res) => {
                        if (res?.access_token) {
                            gapi.client.setToken(res);
                            updateConnectionStatus(true);
                            loadDatabase();
                        }
                    }
                });
            } catch (e) {
                showNotification('Error al inicializar Google API', 'error');
            }
        }

        // === STORAGE ===
        async function loadFromStorage() {
            try {
                const stateRes = await window.storage.get('wms_state');
                if (stateRes?.value) STATE = JSON.parse(stateRes.value);
                
                const bdRes = await window.storage.get('wms_bd');
                if (bdRes?.value) {
                    const cached = JSON.parse(bdRes.value);
                    BD_CODES = new Set(cached.codes);
                    OBC_MAP = new Map(cached.obcMap?.map(([k, v]) => [k, new Set(v)]));
                    OBC_TOTALS = new Map(cached.totals);
                    OBC_INFO = new Map(cached.info);
                    updateDashboardStats();
                }
            } catch (e) {}
        }

        async function saveState() {
            try {
                await window.storage.set('wms_state', JSON.stringify(STATE));
            } catch (e) {}
        }

        async function saveBD() {
            try {
                await window.storage.set('wms_bd', JSON.stringify({
                    codes: Array.from(BD_CODES),
                    obcMap: Array.from(OBC_MAP.entries()).map(([k, v]) => [k, Array.from(v)]),
                    totals: Array.from(OBC_TOTALS.entries()),
                    info: Array.from(OBC_INFO.entries())
                }));
            } catch (e) {}
        }

        // === AUTHENTICATION ===
        function handleAuthClick() {
            gapi.client.getToken() ? google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                gapi.client.setToken(null);
                updateConnectionStatus(false);
            }) : TOKEN_CLIENT.requestAccessToken();
        }

        function updateConnectionStatus(connected) {
            document.getElementById('status-conn').className = `status-indicator ${connected ? 'status-ok' : 'status-error'}`;
            document.getElementById('conn-label').textContent = connected ? 'Conectado' : 'Desconectado';
            document.getElementById('connect-btn').textContent = connected ? 'üîì Cerrar Sesi√≥n' : 'üîó Conectar';
            document.getElementById('load-bd-btn').style.display = connected ? 'block' : 'none';
            updateStartButton();
        }

        function updateStartButton() {
            const canStart = gapi.client.getToken() && BD_CODES.size > 0;
            document.getElementById('start-btn').disabled = !canStart;
        }

        // === DATABASE LOADING ===
        async function loadDatabase() {
            if (!gapi.client.getToken()) {
                showNotification('Conecta primero con Google Sheets', 'warning');
                return;
            }

            showNotification('Cargando base de datos...', 'info');
            
            try {
                // Load Resumen
                const resRes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_BD,
                    range: 'Resumen!A:E'
                });

                const resRows = resRes.result.values;
                if (resRows?.length > 1) {
                    OBC_TOTALS.clear();
                    OBC_INFO.clear();
                    
                    for (let i = 1; i < resRows.length; i++) {
                        const [obc, ref, time, recipient, count] = resRows[i];
                        if (obc && count) {
                            OBC_TOTALS.set(obc, parseInt(count));
                            OBC_INFO.set(obc, { recipient, arrivalTime: time, referenceOrder: ref });
                        }
                    }
                }

                // Load BD codes
                const sheets = ['BD', 'Outbound_Âá∫Â∫ìÂçï', 'Sheet1'];
                for (const sheet of sheets) {
                    try {
                        const codesRes = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_BD,
                            range: `${sheet}!A:I`
                        });

                        const rows = codesRes.result.values;
                        if (rows?.length > 1) {
                            BD_CODES.clear();
                            OBC_MAP.clear();
                            
                            for (let i = 1; i < rows.length; i++) {
                                const obc = rows[i][0]?.toString().trim();
                                const concat = rows[i][8]?.toString().trim();
                                if (obc && concat) {
                                    const norm = normalizeCode(concat);
                                    BD_CODES.add(norm);
                                    if (!OBC_MAP.has(obc)) OBC_MAP.set(obc, new Set());
                                    OBC_MAP.get(obc).add(norm);
                                }
                            }
                            
                            await saveBD();
                            updateDashboardStats();
                            document.getElementById('status-bd').className = 'status-indicator status-ok';
                            document.getElementById('bd-label').textContent = 'Cargada';
                            updateStartButton();
                            showNotification(`‚úÖ BD cargada: ${BD_CODES.size} c√≥digos en ${OBC_TOTALS.size} √≥rdenes`, 'success');
                            playSound('ok');
                            return;
                        }
                    } catch (e) {}
                }
                
                throw new Error('No se pudo cargar la BD');
            } catch (err) {
                showNotification('‚ùå Error al cargar BD', 'error');
                console.error(err);
            }
        }

        function updateDashboardStats() {
            document.getElementById('dash-bd').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('bd-count-sidebar').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('dash-orders').textContent = OBC_TOTALS.size || '-';
            
            let totalValidated = 0;
            for (const obc in STATE.tabs) {
                totalValidated += STATE.tabs[obc].validations.length;
            }
            document.getElementById('dash-validated').textContent = totalValidated || '-';
        }

        // === CODE EXTRACTION (MEJORADO) ===
        function extractCode(raw) {
            const code = raw.trim();
            
            // Patr√≥n 1: JSON format - buscar entre corchetes [ID[√ë [CODIGO[
            const jsonPattern1 = /\[id\[.*?\[([\d\/\-]+)\[/i;
            const jsonPattern2 = /¬®id¬®.*?¬®([\d\/\-]+)¬®/i;
            
            const match1 = code.match(jsonPattern1);
            if (match1) return match1[1];
            
            const match2 = code.match(jsonPattern2);
            if (match2) return match2[1];
            
            // Patr√≥n 2: C√≥digo directo num√©rico con / o -
            const directPattern = /^([\d\/\-]+)/;
            const match3 = code.match(directPattern);
            if (match3) return match3[1];
            
            // Fallback: retornar tal cual
            return code;
        }

        function normalizeCode(code) {
            return code ? code.replace(/-/g, '/').toLowerCase().trim() : '';
        }

        // === VALIDATION LOGIC ===
        function setupListeners() {
            const scanner = document.getElementById('scanner');
            const location = document.getElementById('location-input');
            
            scanner.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && scanner.value.trim()) {
                    e.preventDefault();
                    processScan(scanner.value.trim());
                    scanner.value = '';
                }
            });
            
            location.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    scanner.focus();
                }
            });
        }

        async function processScan(raw) {
            if (BD_CODES.size === 0) {
                showNotification('‚ö†Ô∏è Carga la BD primero', 'warning');
                playSound('error');
                return;
            }

            const activeOBC = STATE.activeOBC;
            const tab = STATE.tabs[activeOBC];
            
            const extracted = extractCode(raw);
            const normalized = normalizeCode(extracted);
            const concatenated = normalized + activeOBC.toLowerCase();
            
            console.log('Raw:', raw);
            console.log('Extracted:', extracted);
            console.log('Normalized:', normalized);
            console.log('Concatenated:', concatenated);
            
            // Check if exists
            if (!BD_CODES.has(concatenated)) {
                await handleRejection('NO_EXISTE_EN_BD', raw, normalized, activeOBC);
                return;
            }
            
            // Check duplicates
            const isDup = tab.validations.find(v => v.code === normalized);
            if (isDup) {
                lastScanned = { raw, code: normalized, obc: activeOBC, user: tab.user, location: tab.location, duplicate: isDup };
                showPopup('dup', normalized, isDup);
                playSound('duplicate');
                return;
            }
            
            // Validate OK
            await handleValidationOK(raw, normalized, activeOBC, tab.user, tab.location);
        }

        async function handleValidationOK(raw, code, obc, user, location, note = '') {
            const tab = STATE.tabs[obc];
            const now = new Date();
            
            const log = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX'),
                date: now.toISOString().slice(0, 10),
                user, obc, raw, code, location, note
            };
            
            tab.validations.unshift(log);
            playSound('ok');
            flashInput('success');
            renderValidation();
            await saveState();
            
            if (gapi.client.getToken()) await writeToSheets('Val3', log);
        }

        async function handleRejection(reason, raw, code, obc) {
            const tab = STATE.tabs[obc];
            const now = new Date();
            
            const log = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX'),
                date: now.toISOString().slice(0, 10),
                user: tab.user, obc, raw, code, reason
            };
            
            tab.rejections.unshift(log);
            playSound('error');
            flashInput('error');
            showPopup('error', code, reason);
            renderValidation();
            await saveState();
            
            if (gapi.client.getToken()) await writeToSheets('Validaciones_RECHAZADAS', log);
        }

        async function writeToSheets(sheet, log) {
            try {
                const values = sheet === 'Val3' 
                    ? [[log.date, log.timestamp, log.user, log.obc, log.code, log.location, log.note]]
                    : [[log.date, log.timestamp, log.user, log.obc, log.raw, log.reason, log.code]];
                
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_WRITE,
                    range: `${sheet}!A1`,
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values }
                });
            } catch (e) {
                console.error('Error writing to sheets:', e);
            }
        }

        // === RENDERING ===
        function renderValidation() {
            const activeOBC = STATE.activeOBC;
            const tab = STATE.tabs[activeOBC];
            
            // Update progress
            const total = OBC_TOTALS.get(activeOBC) || 0;
            const scanned = tab.validations.length;
            const remaining = Math.max(0, total - scanned);
            const pct = total > 0 ? Math.min(100, (scanned / total) * 100) : 0;
            
            document.getElementById('prog-obc').textContent = activeOBC;
            document.getElementById('prog-pct').textContent = `${pct.toFixed(0)}%`;
            document.getElementById('prog-scan').textContent = scanned;
            document.getElementById('prog-total').textContent = total;
            document.getElementById('prog-rest').textContent = remaining;
            document.getElementById('prog-bar').style.width = `${pct}%`;
            
            // Update stats
            const rejected = tab.rejections.filter(r => r.reason === 'NO_EXISTE_EN_BD').length;
            document.getElementById('stat-ok').textContent = scanned;
            document.getElementById('stat-error').textContent = rejected;
            
            // Update tabs
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            Object.keys(STATE.tabs).forEach(obc => {
                const t = document.createElement('div');
                t.className = `tab ${obc === activeOBC ? 'active' : ''}`;
                t.textContent = obc;
                t.onclick = () => switchOBC(obc);
                tabBar.appendChild(t);
            });
            const newTab = document.createElement('div');
            newTab.className = 'tab new-tab';
            newTab.textContent = '+ Nueva Orden';
            newTab.onclick = addOBC;
            tabBar.appendChild(newTab);
            
            // Update inputs
            document.getElementById('user-select').value = tab.user;
            document.getElementById('obc-display').value = activeOBC;
            document.getElementById('location-input').value = tab.location;
            
            // Update logs
            const okList = document.getElementById('log-ok');
            const rejectList = document.getElementById('log-reject');
            okList.innerHTML = '';
            rejectList.innerHTML = '';
            
            tab.validations.slice(0, 10).forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item log-ok';
                li.innerHTML = `
                    <div class="log-info">
                        <div class="log-code">${log.code}</div>
                        <div class="log-meta">${log.timestamp} ‚Ä¢ ${log.location || '-'}</div>
                    </div>
                `;
                okList.appendChild(li);
            });
            
            tab.rejections.slice(0, 10).forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item log-reject';
                li.innerHTML = `
                    <div class="log-info">
                        <div class="log-code">${log.code}</div>
                        <div class="log-meta">${log.timestamp} ‚Ä¢ ${log.reason}</div>
                    </div>
                `;
                rejectList.appendChild(li);
            });
            
            // Update sidebar OBC list
            const obcList = document.getElementById('obc-list');
            obcList.innerHTML = '';
            Object.keys(STATE.tabs).forEach(obc => {
                const tab = STATE.tabs[obc];
                const total = OBC_TOTALS.get(obc) || 0;
                const count = tab.validations.length;
                const pct = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                
                const div = document.createElement('div');
                div.style.cssText = 'padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 0.85em;';
                div.innerHTML = `
                    <div style="font-weight: 700;">${obc}</div>
                    <div style="opacity: 0.8;">${count}/${total} (${pct}%)</div>
                `;
                obcList.appendChild(div);
            });
            
            updateDashboardStats();
        }

        function switchOBC(obc) {
            STATE.activeOBC = obc;
            renderValidation();
            document.getElementById('location-input').focus();
            saveState();
        }

        function addOBC() {
            const obc = prompt('Ingresa el n√∫mero de la nueva orden:');
            if (!obc) return;
            
            const obcName = obc.toUpperCase().trim();
            if (STATE.tabs[obcName]) {
                showNotification('‚ö†Ô∏è Esta orden ya existe', 'warning');
                return;
            }
            
            STATE.tabs[obcName] = {
                user: STATE.tabs[STATE.activeOBC].user,
                location: '',
                validations: [],
                rejections: []
            };
            switchOBC(obcName);
            showNotification(`‚úÖ Orden ${obcName} creada`, 'success');
        }

        function updateState() {
            const tab = STATE.tabs[STATE.activeOBC];
            tab.user = document.getElementById('user-select').value;
            tab.location = document.getElementById('location-input').value.toUpperCase().trim();
            saveState();
        }

        function populateUsers() {
            const select = document.getElementById('user-select');
            USERS.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                select.appendChild(opt);
            });
        }

        // === NAVIGATION ===
        function startValidation() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
            document.getElementById('scanner').focus();
            renderValidation();
        }

        function returnToDashboard() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            updateDashboardStats();
        }

        function showResumen() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('resumen-module').style.display = 'block';
            renderResumen();
        }

        function hideResumen() {
            document.getElementById('resumen-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        function showFaltantes() {
            document.getElementById('validation').style.display = 'none';
            document.getElementById('faltantes-module').style.display = 'block';
            renderFaltantes();
        }

        function hideFaltantes() {
            document.getElementById('faltantes-module').style.display = 'none';
            document.getElementById('validation').style.display = 'block';
        }

        // === RESUMEN MODULE ===
        function renderResumen() {
            const tbody = document.getElementById('resumen-tbody');
            tbody.innerHTML = '';
            
            Object.keys(STATE.tabs).forEach(obc => {
                const tab = STATE.tabs[obc];
                const total = OBC_TOTALS.get(obc) || 0;
                const validated = tab.validations.length;
                const pct = total > 0 ? ((validated / total) * 100).toFixed(0) : 0;
                const info = OBC_INFO.get(obc) || {};
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${obc}</strong></td>
                    <td>${total}</td>
                    <td>${validated}</td>
                    <td>${pct}%</td>
                    <td>${info.recipient || '-'}</td>
                    <td>${info.arrivalTime || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterResumen() {
            const search = document.getElementById('search-resumen').value.toLowerCase();
            const rows = document.querySelectorAll('#resumen-tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // === FALTANTES MODULE ===
        function renderFaltantes() {
            const activeOBC = STATE.activeOBC;
            const tab = STATE.tabs[activeOBC];
            const obcCodes = OBC_MAP.get(activeOBC);
            
            document.getElementById('faltantes-title').textContent = `Orden: ${activeOBC}`;
            
            const grid = document.getElementById('faltantes-grid');
            grid.innerHTML = '';
            
            if (!obcCodes) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">No hay datos para esta orden</div>';
                return;
            }
            
            const validated = new Set(tab.validations.map(v => v.code));
            
            Array.from(obcCodes).forEach(code => {
                const div = document.createElement('div');
                div.className = `faltante-item ${validated.has(code) ? 'faltante-ok' : 'faltante-pending'}`;
                div.textContent = code;
                grid.appendChild(div);
            });
        }

        // === POPUPS ===
        function showPopup(type, code, data) {
            if (type === 'error') {
                document.getElementById('err-code').textContent = code;
                document.getElementById('err-reason').textContent = data;
                document.getElementById('popup-error').style.display = 'flex';
            } else if (type === 'dup') {
                document.getElementById('dup-code').textContent = code;
                document.getElementById('dup-when').textContent = `${data.date} ${data.timestamp}`;
                document.getElementById('dup-user').textContent = data.user;
                document.getElementById('popup-dup').style.display = 'flex';
            }
            document.getElementById('scanner').blur();
        }

        function closePopup(type) {
            document.getElementById(`popup-${type}`).style.display = 'none';
            document.getElementById('scanner').focus();
            lastScanned = null;
        }

        function forceDuplicate() {
            const note = prompt('Justificaci√≥n del duplicado:') || 'Sin justificaci√≥n';
            if (lastScanned) {
                handleValidationOK(lastScanned.raw, lastScanned.code, lastScanned.obc, lastScanned.user, lastScanned.location, `DUPLICADO FORZADO: ${note}`);
            }
            closePopup('dup');
        }

        // === AUDIO ===
        function playSound(type) {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                
                if (type === 'ok') {
                    osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                } else if (type === 'error') {
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                } else if (type === 'duplicate') {
                    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                    setTimeout(() => {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        osc2.frequency.setValueAtTime(600, audioCtx.currentTime);
                        osc2.start();
                        osc2.stop(audioCtx.currentTime + 0.1);
                    }, 150);
                }
            } catch (e) {}
        }

        function flashInput(type) {
            const input = document.getElementById('scanner');
            input.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--error)';
            setTimeout(() => input.style.borderColor = '#ddd', 300);
        }

        // === NOTIFICATIONS ===
        function showNotification(msg, type) {
            const container = document.getElementById('notifications');
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.innerHTML = `<strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${msg}`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // === EXPORT ===
        function exportData() {
            const rows = [];
            rows.push('Fecha,Hora,Usuario,Orden,C√≥digo,Ubicaci√≥n,Nota');
            
            for (const obc in STATE.tabs) {
                STATE.tabs[obc].validations.forEach(log => {
                    rows.push(`${log.date},${log.timestamp},${log.user},${log.obc},${log.code},${log.location || ''},${log.note || ''}`);
                });
            }
            
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `validaciones_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            showNotification('üì• Datos exportados', 'success');
        }
    </script>
</body>
</html>
