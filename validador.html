<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validación de Warehouse - OBC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; }
        .sidebar { width: 250px; background-color: #333; color: white; padding: 20px; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { color: #444; }
        .tab-bar { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background-color: #eee; margin-right: 5px; border-top-left-radius: 5px; border-top-right-radius: 5px; }
        .tab.active { background-color: white; border-color: #ddd; border-bottom: 2px solid white; font-weight: bold; }
        .input-group { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group label { display: block; margin-top: 10px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .scanner-input { font-size: 1.5em; text-transform: uppercase; }
        .stats { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .stat-box { text-align: center; padding: 15px; border-radius: 8px; flex-grow: 1; margin: 0 10px; }
        .stat-ok { background-color: #e6ffe6; border: 1px solid #00c000; }
        .stat-error { background-color: #ffe6e6; border: 1px solid #c00000; }
        .stat-rate { background-color: #f0f0ff; border: 1px solid #0000c0; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .logs-container { display: flex; gap: 20px; }
        .log-section { flex: 1; background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log-list { max-height: 250px; overflow-y: auto; list-style: none; padding: 0; }
        .log-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #eee; font-size: 0.9em; }
        .log-item:last-child { border-bottom: none; }
        .log-ok { color: green; }
        .log-reject { color: red; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #ccc; color: #333; }
        .btn-edit { background-color: transparent; color: #007bff; border: none; cursor: pointer; font-size: 0.8em; }
        .btn-google { background-color: #db4437; color: white; margin-bottom: 10px; }

        /* Estilos de los Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .popup-content { background: white; padding: 30px; border-radius: 8px; width: 400px; text-align: center; }
        .popup-header { font-size: 1.5em; margin-bottom: 20px; font-weight: bold; }
        .popup-details { text-align: left; margin-bottom: 20px; background: #f0f0f0; padding: 15px; border-radius: 4px; }
        .popup-buttons button { margin: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Menú</h2>
        
        <button id="auth-button" class="btn btn-google" onclick="handleAuthClick()">Conectar con Google Sheets</button>
        <div style="font-size: 0.8em; margin-bottom: 10px;" id="auth-status">Desconectado</div>

        <p>BD Cargada: <span id="bd-count">0</span> códigos</p>
        <button class="btn btn-primary" onclick="loadDatabase()">Cargar BD desde Sheets</button>
        <hr style="margin: 15px 0;">
        <h3>Usuarios</h3>
        <select id="user-select" onchange="updateGlobalState()">
            </select>
        <hr style="margin: 15px 0;">
        <h3>OBCs Activas</h3>
        <div id="obc-list">
            </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Sistema de Validación</h1>
            <button class="btn btn-secondary" onclick="exportData()">Exportar Datos (CSV)</button>
        </div>

        <div id="tab-bar" class="tab-bar">
            </div>

        <div id="validation-area">
            <div class="input-group">
                <label>Usuario Activo:</label>
                <input type="text" id="active-user-display" disabled>
                <label>OBC Activa:</label>
                <input type="text" id="active-obc-display" disabled>
                <label>Ubicación Global (Opcional):</label>
                <input type="text" id="global-location" placeholder="Ej: PLEC123, 4971098/1" onchange="updateGlobalState()">
                <hr style="margin: 15px 0;">
                <label for="scanner-input">ESCANEAR CAJA (Presiona Enter):</label>
                <input type="text" id="scanner-input" class="scanner-input" autofocus placeholder="Escanea el código de la caja aquí">
            </div>

            <div class="stats">
                <div class="stat-box stat-ok">
                    VALIDADAS OK
                    <div class="stat-number" id="validated-count">0</div>
                </div>
                <div class="stat-box stat-error">
                    RECHAZADAS
                    <div class="stat-number" id="rejected-count">0</div>
                </div>
                <div class="stat-box stat-rate">
                    TASA ERROR
                    <div class="stat-number" id="error-rate">0.0%</div>
                </div>
            </div>

            <div class="logs-container">
                <div class="log-section">
                    <h3>Últimas Validaciones OK</h3>
                    <ul id="ok-logs" class="log-list"></ul>
                </div>
                <div class="log-section">
                    <h3>Rechazos</h3>
                    <ul id="reject-logs" class="log-list"></ul>
                </div>
            </div>
        </div>

    </div>

    <div id="error-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: red;">VALIDACIÓN RECHAZADA ❌</div>
            <div class="popup-details">
                Código: <strong id="error-code"></strong><br>
                OBC: <strong id="error-obc"></strong><br>
                Motivo: <strong id="error-reason"></strong>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closeErrorPopup()">Continuar Escaneando</button>
            </div>
        </div>
    </div>

    <div id="duplicate-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: orange;">CAJA YA VALIDADA ⚠️</div>
            <div class="popup-details">
                Código: <strong id="dup-code"></strong><br>
                OBC: <strong id="dup-obc"></strong><br>
                <hr>
                Validada anteriormente:<br>
                • <span id="dup-timestamp"></span><br>
                • Usuario: <span id="dup-user"></span><br>
                • Ubicación: <span id="dup-location"></span>
            </div>
            <p>¿Qué deseas hacer?</p>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="handleDuplicateAction('ignore')">Ignorar - No guardar</button>
                <button class="btn btn-primary" onclick="showForcedNoteModal()">Forzar entrada con nota</button>
            </div>
        </div>
    </div>

    <div id="forced-note-modal" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">Forzar Duplicado</div>
            <p>Añade una nota para justificar el duplicado:</p>
            <input type="text" id="forced-note-input" style="width: 100%; margin-bottom: 15px;" placeholder="Ej: Cambio de ubicación por error de pickeo.">
            <button class="btn btn-primary" onclick="handleDuplicateAction('force')">Guardar Forzado</button>
            <button class="btn btn-secondary" onclick="document.getElementById('forced-note-modal').style.display='none'; document.getElementById('duplicate-popup').style.display='flex';">Volver</button>
        </div>
    </div>


    <script async defer src="https://apis.google.com/js/api.js"></script>

    <script>
        // --- 1. CONFIGURACIÓN DE LA API (CLIENT ID AJUSTADO) ---
        const CLIENT_ID = '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com'; 

        const SPREADSHEET_ID = '1gU5yDb0R4_Mf1fE-lOA7vwYmTUBR0wV7EPGg5zUt2Xo'; 
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets'; 

        // --- 2. CONFIGURACIÓN INICIAL DE LA APLICACIÓN ---
        const VALIDATORS = ['MIGUEL', 'PEDRO', 'ALEJANDRO', 'ESMERALDA', 'KATERYNE'];
        const STORAGE_KEY = 'wms_validation_state';

        let BD_CODES = new Set(); 
        let GLOBAL_STATE = { 
            activeOBC: 'OBC_DEFAULT_1',
            tabs: { 
                'OBC_DEFAULT_1': { 
                    user: 'MIGUEL', 
                    location: '', 
                    validations: [], 
                    rejections: [],  
                } 
            }
        };
        let lastScannedCode = null; 

        let TOKEN_CLIENT;

        // Inicializar la API de Google y la aplicación
        gapi.load('client', () => {
            gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            }).then(() => {
                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            gapi.client.setToken(tokenResponse);
                            updateAuthStatus(true);
                            // Cargar la BD automáticamente después de la conexión
                            loadDatabase();
                        } else {
                            updateAuthStatus(false);
                        }
                    },
                });
                updateAuthStatus(false); 
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialState();
            setupEventListeners();
            populateUserSelect();
            renderApp();
        });


        // --- 3. GESTIÓN DE AUTENTICACIÓN Y ESTADO ---

        function updateAuthStatus(isSignedIn) {
            const statusElement = document.getElementById('auth-status');
            const button = document.getElementById('auth-button');
            if (isSignedIn) {
                statusElement.textContent = "Conectado. ✅";
                statusElement.style.color = 'lightgreen';
                button.textContent = "Cerrar Sesión";
            } else {
                statusElement.textContent = "Desconectado. ❌";
                statusElement.style.color = 'yellow';
                button.textContent = "Conectar con Google Sheets";
            }
        }

        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                // Iniciar sesión
                TOKEN_CLIENT.requestAccessToken();
            } else {
                // Cerrar sesión
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                    gapi.client.setToken(null);
                    updateAuthStatus(false);
                    document.getElementById('bd-count').textContent = '0';
                    BD_CODES = new Set();
                    alert("Sesión cerrada. Los nuevos escaneos solo se guardarán localmente.");
                });
            }
        }

        function loadInitialState() {
            const savedState = localStorage.getItem(STORAGE_KEY);
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                for (const obc in parsedState.tabs) {
                    parsedState.tabs[obc].validations = parsedState.tabs[obc].validations || [];
                    parsedState.tabs[obc].rejections = parsedState.tabs[obc].rejections || [];
                }
                GLOBAL_STATE = parsedState;
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(GLOBAL_STATE));
        }

        function updateGlobalState() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];

            tab.user = document.getElementById('user-select').value;
            tab.location = document.getElementById('global-location').value.toUpperCase().trim();
            
            document.getElementById('active-user-display').value = tab.user;
            document.getElementById('active-obc-display').value = activeOBC;

            saveState();
        }

        function switchOBC(obc) {
            GLOBAL_STATE.activeOBC = obc;
            renderApp();
            saveState();
        }

        function addOBC() {
            const newOBC = prompt("Ingresa el número de la nueva OBC (Ej: OBC31251120RV):").toUpperCase().trim();
            if (newOBC && !GLOBAL_STATE.tabs[newOBC]) {
                GLOBAL_STATE.tabs[newOBC] = {
                    user: GLOBAL_STATE.tabs[GLOBAL_STATE.activeOBC].user, 
                    location: '', 
                    validations: [],
                    rejections: [],
                };
                switchOBC(newOBC);
            }
        }

        // --- 4. GESTIÓN DE BASES DE DATOS (LECTURA API) ---

        /**
         * Carga la BD de códigos en la memoria usando la Sheets API.
         */
        async function loadDatabase() {
            if (!gapi.client.getToken()) {
                alert("Primero debes hacer clic en 'Conectar con Google Sheets'.");
                return;
            }
            document.getElementById('bd-count').textContent = 'Cargando...';

            try {
                // Leer la Columna I de la hoja "BD"
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'BD!I:I', 
                });

                const codes = response.result.values;
                if (codes) {
                    // Normalizamos y creamos un Set para búsquedas rápidas (<300ms)
                    const dbCodes = new Set(codes.flat()
                        .map(code => code ? normalizeCode(code) : '') 
                        .filter(code => code !== '')
                    ); 
                    BD_CODES = dbCodes;
                    document.getElementById('bd-count').textContent = BD_CODES.size;
                    alert(`Base de Datos cargada: ${BD_CODES.size} códigos listos para validar.`);
                }
            } catch (err) {
                console.error('Error al cargar la Base de Datos desde Google Sheets:', err);
                alert('ERROR: No se pudo cargar la BD. Asegúrate de tener permisos y que la hoja "BD" exista.');
                document.getElementById('bd-count').textContent = '0 (Error)';
            }
        }

        // --- 5. GESTIÓN DE REGISTROS (ESCRITURA API) ---

        /**
         * Guarda un registro de validación (OK o RECHAZO) en Google Sheets.
         */
        async function saveValidationLog(sheetName, logRecord) {
            if (!gapi.client.getToken()) {
                console.warn("No autenticado. El registro solo se guardará localmente.");
                return;
            }
            
            const range = `${sheetName}!A1`; 
            let values = [];

            if (sheetName.startsWith('Val')) { // Logs OK (Val3, Val4, etc.)
                values = [[
                    logRecord.date,
                    logRecord.timestamp,
                    logRecord.user,
                    logRecord.obc,
                    logRecord.extractedCode,
                    logRecord.location,
                    logRecord.note
                ]];
            } else if (sheetName.includes('RECHAZADAS')) { // Logs de Rechazo
                values = [[
                    logRecord.date,
                    logRecord.timestamp,
                    logRecord.user,
                    logRecord.obc,
                    logRecord.codeScanned, // Código crudo escaneado
                    logRecord.rejectionReason,
                    logRecord.extractedCode // Código extraído/normalizado (si aplica)
                ]];
            }

            if (values.length === 0) return;

            const resource = { values };

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED', 
                    insertDataOption: 'INSERT_ROWS',
                });
                console.log(`Log exitosamente escrito en ${sheetName}.`);
            } catch (err) {
                console.error(`Error al escribir log en ${sheetName}. Asegúrate de que las hojas existan.`, err);
                alert(`ADVERTENCIA: Falló la escritura en Sheets (${sheetName}). Datos solo guardados localmente.`);
            }
        }

        // --- 6. EXTRACCIÓN Y NORMALIZACIÓN DE CÓDIGOS ---
        const normalizeCode = (code) => {
            return code ? code.replace(/-/g, '/').toLowerCase().trim() : ''; 
        };

        const extractCode = (rawCode) => {
            const code = rawCode.trim();
            const jsonPattern = /¨id¨ñ ¨|\[ID\[ñ\[/i; 
            if (code.match(jsonPattern)) {
                const startMarker = code.includes('¨id¨ñ ¨') ? '¨id¨ñ ¨' : '[ID[ñ [';
                const endMarker = code.includes('¨id¨ñ ¨') ? '¨,' : '[,';

                const startIndex = code.indexOf(startMarker);
                if (startIndex !== -1) {
                    const startPos = startIndex + startMarker.length;
                    const endIndex = code.indexOf(endMarker, startPos);
                    if (endIndex !== -1) {
                        return code.substring(startPos, endIndex).trim();
                    }
                }
            }
            return code;
        };


        // --- 7. LÓGICA DE VALIDACIÓN PRINCIPAL ---

        function setupEventListeners() {
            const input = document.getElementById('scanner-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    processScan(input.value.trim());
                    input.value = ''; 
                }
            });
        }

        function processScan(rawCode) {
            if (BD_CODES.size === 0) {
                 alert("ERROR: La Base de Datos no ha sido cargada. Por favor, haz clic en 'Cargar BD desde Sheets'.");
                 return;
            }

            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];
            const user = tab.user;
            const location = tab.location;
            
            lastScannedCode = { rawCode, extracted: null, obc: activeOBC, user, location };

            const extractedCode = extractCode(rawCode);
            const normalizedCode = normalizeCode(extractedCode);
            lastScannedCode.extracted = normalizedCode;

            // 1. Buscar en BD (Validación estricta)
            if (!BD_CODES.has(normalizedCode)) {
                handleRejection('NO_EXISTE_EN_BD', rawCode, normalizedCode, activeOBC);
                return;
            }

            // 2. Verificar Duplicados (Solo con la OBC actual)
            const isDuplicate = tab.validations.find(v => v.extractedCode === normalizedCode && v.obc === activeOBC);

            if (isDuplicate) {
                // Mismo código + Misma OBC -> ALERTA
                lastScannedCode.duplicateOf = isDuplicate; 
                showDuplicatePopup(normalizedCode, activeOBC, isDuplicate); 
                playAudio('duplicate');
                return;
            }
            
            // 3. Validar OK
            handleValidationOK(rawCode, extractedCode, normalizedCode, activeOBC, user, location);
        }

        function handleValidationOK(rawCode, extractedCode, normalizedCode, obc, user, location, note = '') {
            const tab = GLOBAL_STATE.tabs[obc];
            const now = new Date();
            const newLog = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                date: now.toISOString().slice(0, 10),
                user,
                obc,
                originalCode: rawCode,
                extractedCode: normalizedCode,
                location,
                note
            };
            tab.validations.unshift(newLog); 
            playAudio('ok');
            renderLogs();
            saveState();

            // CRÍTICO: Escritura a Google Sheets (usaremos Val3 por defecto)
            saveValidationLog('Val3', newLog); 
        }

        function handleRejection(reason, rawCode, normalizedCode, obc) {
            const tab = GLOBAL_STATE.tabs[obc];
            const now = new Date();
            const newLog = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                date: now.toISOString().slice(0, 10),
                user: tab.user,
                obc,
                codeScanned: rawCode,
                extractedCode: normalizedCode,
                rejectionReason: reason, 
            };
            tab.rejections.unshift(newLog);
            playAudio('error');
            showErrorPopup(normalizedCode, obc, reason);
            renderLogs();
            saveState();

            // CRÍTICO: Escritura a Google Sheets
            saveValidationLog('Validaciones_RECHAZADAS', newLog);
        }

        // --- 8. RENDERING, LOGS Y POPUPS (Se mantienen igual) ---

        function renderApp() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];

            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            const obcKeys = Object.keys(GLOBAL_STATE.tabs);

            obcKeys.forEach(obc => {
                const tabDiv = document.createElement('div');
                tabDiv.className = `tab ${obc === activeOBC ? 'active' : ''}`;
                tabDiv.textContent = obc;
                tabDiv.onclick = () => switchOBC(obc);
                tabBar.appendChild(tabDiv);
            });

            const newTabBtn = document.createElement('div');
            newTabBtn.className = 'tab';
            newTabBtn.textContent = '+ Nueva';
            newTabBtn.onclick = addOBC;
            tabBar.appendChild(newTabBtn);

            document.getElementById('active-user-display').value = tab.user;
            document.getElementById('active-obc-display').value = activeOBC;
            document.getElementById('global-location').value = tab.location;

            const validatedCount = tab.validations.length;
            const rejectedCount = tab.rejections.filter(r => r.rejectionReason === 'NO_EXISTE_EN_BD').length; 
            const totalScans = validatedCount + tab.rejections.length; 
            const errorRate = totalScans > 0 ? ((rejectedCount / totalScans) * 100).toFixed(1) : '0.0';

            document.getElementById('validated-count').textContent = validatedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;
            document.getElementById('error-rate').textContent = `${errorRate}%`;

            renderLogs();
        }

        function renderLogs() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];
            const okLogsList = document.getElementById('ok-logs');
            const rejectLogsList = document.getElementById('reject-logs');

            okLogsList.innerHTML = '';
            rejectLogsList.innerHTML = '';

            tab.validations.slice(0, 5).forEach(log => {
                const item = document.createElement('li');
                item.className = 'log-item log-ok';
                item.innerHTML = `
                    <span>${log.extractedCode}</span>
                    <span>${log.timestamp}</span>
                    <span>${log.location || '-'}</span>
                    <button class="btn-edit" onclick="showEditModal(${log.id}, '${activeOBC}')">[Edit]</button>
                `;
                okLogsList.appendChild(item);
            });

            tab.rejections.slice(0, 5).forEach(log => {
                const item = document.createElement('li');
                item.className = 'log-item log-reject';
                const reasonDisplay = log.rejectionReason === 'DUPLICADO_FORZADO' ? 'DUPLICADO (FORZADO)' : log.rejectionReason.replace(/_/g, ' ');
                item.innerHTML = `
                    <span>${log.extractedCode || log.codeScanned}</span>
                    <span>- ${reasonDisplay}</span>
                `;
                rejectLogsList.appendChild(item);
            });
        }
        
        function populateUserSelect() {
            const select = document.getElementById('user-select');
            VALIDATORS.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
            select.value = GLOBAL_STATE.tabs[GLOBAL_STATE.activeOBC].user;
        }

        function showErrorPopup(code, obc, reason) {
            document.getElementById('error-code').textContent = code;
            document.getElementById('error-obc').textContent = obc;
            document.getElementById('error-reason').textContent = reason.replace(/_/g, ' ');
            document.getElementById('error-popup').style.display = 'flex';
            document.getElementById('scanner-input').blur(); 
        }

        function closeErrorPopup() {
            document.getElementById('error-popup').style.display = 'none';
            document.getElementById('scanner-input').focus();
        }

        function showDuplicatePopup(code, obc, previousLog) {
            document.getElementById('dup-code').textContent = code;
            document.getElementById('dup-obc').textContent = obc;
            document.getElementById('dup-timestamp').textContent = previousLog.date + ' ' + previousLog.timestamp;
            document.getElementById('dup-user').textContent = previousLog.user;
            document.getElementById('dup-location').textContent = previousLog.location || 'N/A';
            document.getElementById('duplicate-popup').style.display = 'flex';
            document.getElementById('scanner-input').blur();
        }

        function showForcedNoteModal() {
            document.getElementById('duplicate-popup').style.display = 'none';
            document.getElementById('forced-note-modal').style.display = 'flex';
        }

        function handleDuplicateAction(action) {
            document.getElementById('duplicate-popup').style.display = 'none';
            document.getElementById('forced-note-modal').style.display = 'none';
            document.getElementById('scanner-input').focus();

            if (!lastScannedCode) return;

            if (action === 'force') {
                const note = document.getElementById('forced-note-input').value.trim();
                const finalNote = `DUPLICADO FORZADO: ${note}`;

                handleValidationOK(
                    lastScannedCode.rawCode, 
                    lastScannedCode.extracted, 
                    lastScannedCode.extracted, 
                    lastScannedCode.obc, 
                    lastScannedCode.user, 
                    lastScannedCode.location, 
                    finalNote
                );
                
                // Registro de rechazo para auditoría (opcional)
                const tab = GLOBAL_STATE.tabs[lastScannedCode.obc];
                const now = new Date();
                tab.rejections.unshift({
                    id: now.getTime() + 1,
                    timestamp: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                    date: now.toISOString().slice(0, 10),
                    user: lastScannedCode.user,
                    obc: lastScannedCode.obc,
                    codeScanned: lastScannedCode.rawCode,
                    extractedCode: lastScannedCode.extracted,
                    rejectionReason: 'DUPLICADO_FORZADO',
                    isForced: true
                });
            } 
            
            lastScannedCode = null; 
            renderApp();
        }

        function playAudio(type) {
            const input = document.getElementById('scanner-input');
            input.style.borderColor = 'black'; 

            if (type === 'ok') {
                input.style.borderColor = 'green';
            } else if (type === 'error') {
                input.style.borderColor = 'red';
            } else if (type === 'duplicate') {
                input.style.borderColor = 'orange';
            }

            setTimeout(() => {
                input.style.borderColor = '#ccc'; 
            }, 300);
        }

        function exportData() {
            const allLogs = [];
            const header = "Timestamp,Usuario,OBC,Código Original,Código Extraído,Ubicación,Nota\n";

            for (const obc in GLOBAL_STATE.tabs) {
                GLOBAL_STATE.tabs[obc].validations.forEach(log => {
                    const timestampString = new Date(log.id).toISOString(); 

                    allLogs.push([
                        timestampString,
                        log.user,
                        log.obc,
                        `"${log.originalCode.replace(/"/g, '""')}"`, 
                        log.extractedCode,
                        log.location,
                        log.note
                    ].join(','));
                });
            }

            const csvContent = header + allLogs.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `validaciones_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Datos exportados a CSV (Solo registros OK locales).");
        }
        
        function showEditModal(logId, obc) {
            const log = GLOBAL_STATE.tabs[obc].validations.find(v => v.id === logId);
            if (!log) return;

            const newLocation = prompt(`Editando ${log.extractedCode}.\n\nNueva Ubicación (actual: ${log.location}):`);
            if (newLocation === null) return; 
            
            const newNote = prompt(`Editando ${log.extractedCode}.\n\nNueva Nota (actual: ${log.note || 'Vacía'}):`);
            if (newNote === null) return; 

            log.location = newLocation.toUpperCase().trim(); 
            log.note = newNote.trim(); 

            const shouldDelete = confirm("¿Deseas ELIMINAR este registro de validación OK?");
            if (shouldDelete) {
                const index = GLOBAL_STATE.tabs[obc].validations.indexOf(log);
                if (index > -1) {
                    GLOBAL_STATE.tabs[obc].validations.splice(index, 1);
                }
            }

            renderLogs();
            saveState();
            alert("Registro actualizado y/o eliminado localmente.");
        }
    </script>
</body>
</html>