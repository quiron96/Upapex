<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n WMS</title>
    <style>
        :root {
            --primary: #ed5224;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --text: #333;
            --bg: #f7f7f7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg); 
            color: var(--text);
        }

        /* === DASHBOARD === */
        #dashboard { max-width: 1100px; margin: 0 auto; padding: 30px 20px; }
        .dash-header { text-align: center; margin-bottom: 40px; }
        .dash-header h1 { font-size: 2.2em; color: var(--primary); margin-bottom: 8px; }
        
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        
        /* New: Make card clickable */
        .dash-card.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dash-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .dash-card-icon { font-size: 2.5em; margin-bottom: 10px; }
        .dash-card-value { font-size: 2em; font-weight: 700; color: var(--primary); margin-top: 5px; }
        
        .status-grid { display: grid; gap: 12px; margin-bottom: 20px; }
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 6px; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: var(--success); }
        .status-error { background: var(--error); }
        
        .btn { padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 1.1em; transition: all 0.2s; width: 100%; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 1.4em; padding: 20px; }
        .btn-google { background: #4285F4; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.85em; width: auto; }

        /* === VALIDATION SCREEN === */
        #validation { display: none; min-height: 100vh; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 200px; background: #333; color: white; padding: 18px; overflow-y: auto; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 15px; overflow-y: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { color: var(--primary); font-size: 1.6em; flex: 1; }
        
        .card { background: white; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Progress Card */
        .progress-card { 
            background: linear-gradient(135deg, #ffa07a 0%, #ff8a52 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }
        .progress-card.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
        }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-obc-name { font-size: 1.2em; font-weight: 700; }
        .progress-percentage { font-size: 2em; font-weight: 800; }
        .progress-counts { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .progress-count-item { text-align: center; }
        .progress-count-number { font-size: 1.4em; font-weight: 700; }
        .progress-count-label { font-size: 0.7em; opacity: 0.85; }
        .progress-bar-container { background: rgba(0,0,0,0.25); height: 10px; border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #fff, #ffd966); transition: width 0.5s; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .progress-bar-fill.completed { background: linear-gradient(90deg, #fff, #81c784) !important; }
        
        /* Link to faltantes */
        .faltantes-link {
            color: white;
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-underline-offset: 2px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
            display: inline-block;
        }
        .faltantes-link:hover {
            text-decoration-thickness: 3px;
            transform: scale(1.05);
        }
        
        /* Inputs en l√≠nea */
        .inline-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; }
        .input-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95em; font-family: inherit; resize: vertical; }
        .scanner-input { font-size: 1.6em !important; text-transform: uppercase; font-weight: bold; text-align: center; background: #fff5ed !important; }
        
        /* Scanner section with manual button */
        .scanner-section {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .scanner-wrapper {
            flex: 1;
        }
        .btn-manual {
            padding: 10px 15px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-manual:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,152,0,0.3);
        }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .stat-box { text-align: center; padding: 15px; border-radius: 8px; }
        .stat-number { font-size: 2em; font-weight: 700; margin-top: 5px; }
        .stat-ok { background: #e8f5e9; border: 2px solid var(--success); color: var(--success); }
        .stat-error { background: #ffebee; border: 2px solid var(--error); color: var(--error); }
        
        /* Logs con numeraci√≥n */
        .logs-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .log-list { max-height: 350px; overflow-y: auto; list-style: none; background: #fafafa; padding: 10px; border-radius: 8px; counter-reset: log-counter; }
        .log-item { display: flex; gap: 8px; padding: 8px; margin-bottom: 6px; background: white; border-radius: 4px; border-left: 4px solid; }
        .log-item::before { content: counter(log-counter) "."; counter-increment: log-counter; font-weight: 700; min-width: 25px; }
        .log-ok { border-color: var(--success); }
        .log-ok::before { color: var(--success); }
        .log-reject { border-color: var(--error); }
        .log-reject::before { color: var(--error); }
        .log-info { flex: 1; }
        .log-code { font-weight: 600; }
        
        /* Tabs */
        .tab-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; align-items: center; }
        .tab { 
            padding: 8px 12px; 
            cursor: pointer; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            background: white; 
            font-weight: 600; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .tab.completed { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .tab.new-tab { background: linear-gradient(135deg, #ffb399, #ff9d7a); color: white; }
        .tab-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.7;
        }
        .tab-close:hover {
            opacity: 1;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-state-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }
        
        /* Notificaciones */
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px; }
        .notification { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-left: 4px solid; animation: slideIn 0.3s; }
        .notification.success { border-color: var(--success); }
        .notification.error { border-color: var(--error); }
        .notification.warning { border-color: var(--warning); }
        .notification.info { border-color: #2196F3; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Popups */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .popup-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; }
        .popup-header { font-size: 1.4em; font-weight: 700; margin-bottom: 15px; }
        .popup-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .popup-close-x {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s;
        }
        .popup-close-x:hover {
            background: #d0d0d0;
            color: #333;
        }
        
        /* Mini alert */
        .mini-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.95);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            animation: fadeInOut 0.4s ease-in-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        /* Resumen Module */
        #resumen-module { display: none; }
        .search-bar { padding: 12px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 100%; font-size: 1em; }
        .resumen-table { width: 100%; border-collapse: collapse; background: white; }
        .resumen-table th, .resumen-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .resumen-table th { background: #f5f5f5; font-weight: 700; }
        
        /* Faltantes Module */
        #faltantes-module { display: none; }
        .faltantes-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .faltantes-controls input {
            flex: 1;
            min-width: 200px;
        }
        .faltantes-controls select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            min-width: 200px;
        }
        .faltantes-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 8px; 
            max-height: 600px; 
            overflow-y: auto; 
        }
        .faltante-item { padding: 10px; border-radius: 6px; text-align: center; font-size: 0.8em; font-weight: 600; word-break: break-all; }
        .faltante-ok { background: #e8f5e9; color: var(--success); }
        .faltante-pending { background: #ffebee; color: var(--error); }
        
        /* Sync status indicator (Updated styles for new states) */
        .sync-status {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .sync-ok {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .sync-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }
        .sync-warning, .sync-offline {
            background: rgba(255, 152, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        /* User Stats List (for Dashboard Popup) */
        .user-stats-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .user-stat-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .user-stat-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .user-stat-bar-container {
            height: 20px;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .user-stat-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            color: white;
            font-size: 0.7em;
            font-weight: 700;
        }
        
        @media (max-width: 1024px) {
            .sidebar { width: 180px; }
        }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; height: auto; }
            .sidebar { width: 100%; }
            .inline-inputs { grid-template-columns: 1fr; }
            .faltantes-grid { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notifications"></div>

    <div id="dashboard">
        <div class="dash-header">
            <h1>üè≠ Sistema de Validaci√≥n WMS</h1>
            <p>Warehouse Management System</p>
        </div>

        <div class="dash-grid">
            <div class="dash-card">
                <div class="dash-card-icon">üì¶</div>
                <div>√ìrdenes de Hoy</div>
                <div class="dash-card-value" id="dash-orders">-</div>
            </div>
            <div class="dash-card clickable" id="validated-card" onclick="openDailyStatsPopup()">
                <div class="dash-card-icon">‚úÖ</div>
                <div>Cajas Validadas</div>
                <div class="dash-card-value" id="dash-validated">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-icon">üìä</div>
                <div>C√≥digos en BD</div>
                <div class="dash-card-value" id="dash-bd">0</div>
            </div>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px; color: var(--primary);">Estado del Sistema</h2>
            <div class="status-grid">
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-conn"></div>
                        Conexi√≥n a Internet
                    </div>
                    <span id="conn-label">Desconectado</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-sheets"></div>
                        Conexi√≥n Google Sheets
                    </div>
                    <span id="sheets-label">Desconectado</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-sync"></div>
                        Estado de Sincronizaci√≥n
                    </div>
                    <span id="sync-label">Sincronizado</span>
                </div>
                <div class="status-row">
                    <div style="display: flex; align-items: center;">
                        <div class="status-indicator" id="status-bd"></div>
                        Base de Datos
                    </div>
                    <span id="bd-label">No cargada</span>
                </div>
            </div>
            <button id="connect-btn" class="btn btn-google" onclick="handleAuthClick()">üîó Conectar con Google Sheets</button>
            <button id="load-bd-btn" class="btn btn-secondary" onclick="loadDatabase()" style="display:none; margin-top:10px;">üìä Cargar Base de Datos</button>
            <button id="manual-sync-btn" class="btn btn-secondary" onclick="forceSync()" style="display:none; margin-top:10px;">üîÑ Sincronizar Pendientes</button>
        </div>

        <button id="start-btn" class="btn btn-success" onclick="startValidation()" disabled style="margin-top: 20px;">
            üöÄ Iniciar Validaci√≥n
        </button>
    </div>

    <div id="validation">
        <div class="container">
            <div class="sidebar">
                <h2 style="color: var(--primary); margin-bottom: 15px; font-size: 1.3em;">WMS</h2>
                <button class="btn btn-primary btn-small" onclick="returnToDashboard()" style="margin-bottom: 10px; width: 100%;">‚Üê Dashboard</button>
                <button class="btn btn-secondary btn-small" onclick="showResumen()" style="margin-bottom: 10px; width: 100%;">üìã Resumen</button>
                <button class="btn btn-secondary btn-small" onclick="showFaltantes()" style="margin-bottom: 10px; width: 100%;">üîç Faltantes</button>
                <hr style="border-color: #555; margin: 15px 0;">
                <div id="sync-status-sidebar" class="sync-status sync-ok" style="display: none;">
                    ‚úÖ Sincronizado
                </div>
                <button class="btn btn-secondary btn-small" onclick="forceSync()" style="margin-bottom: 10px; width: 100%;">üîÑ Sincronizar</button>
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.3em; font-weight: 700; color: var(--primary);" id="bd-count-sidebar">0</div>
                    <div style="font-size: 0.75em; opacity: 0.8;">c√≥digos en BD</div>
                </div>
                <div id="obc-list" style="flex: 1; overflow-y: auto;"></div>
            </div>

            <div class="main-content">
                <div class="header">
                    <h1>üîç Validaci√≥n de Cajas</h1>
                    <button class="btn btn-secondary btn-small" onclick="exportData()">üì• CSV</button>
                </div>

                <div id="content-area">
                    <div id="empty-state" class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No hay √≥rdenes activas</div>
                        <button class="btn btn-primary" onclick="addOBC()" style="width: auto; padding: 12px 30px;">+ Nueva Orden</button>
                    </div>

                    <div id="validation-content" style="display: none;">
                        <div class="tab-bar" id="tab-bar"></div>

                        <div class="progress-card">
                            <div class="progress-header">
                                <div class="progress-obc-name" id="prog-obc">-</div>
                                <div class="progress-percentage" id="prog-pct">0%</div>
                            </div>
                            <div class="progress-counts">
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-scan">0</div>
                                    <div class="progress-count-label">Escaneadas</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-total">0</div>
                                    <div class="progress-count-label">Total</div>
                                </div>
                                <div class="progress-count-item">
                                    <div class="progress-count-number" id="prog-rest">0</div>
                                    <div class="progress-count-label">Faltantes</div>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="prog-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="inline-inputs">
                                <div class="input-group">
                                    <label>üì¶ Orden:</label>
                                    <input type="text" id="obc-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üè¢ Destino:</label>
                                    <input type="text" id="recipient-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üïê Horario:</label>
                                    <input type="text" id="time-display" disabled>
                                </div>
                                <div class="input-group">
                                    <label>üìç Ubicaci√≥n:</label>
                                    <input type="text" id="location-input" placeholder="Ej: PLEC123" onchange="updateState()">
                                </div>
                            </div>
                            <div class="scanner-section">
                                <div class="scanner-wrapper">
                                    <div class="input-group">
                                        <label style="font-size: 1.1em; color: var(--primary);">üì∑ ESCANEAR C√ìDIGO:</label>
                                        <input type="text" id="scanner" class="scanner-input" placeholder="Escanea aqu√≠..." autofocus>
                                    </div>
                                </div>
                                <button class="btn-manual" onclick="openManualInput()">‚úèÔ∏è Manual</button>
                            </div>
                        </div>

                        <div class="stats">
                            <div class="stat-box stat-ok">
                                VALIDADAS
                                <div class="stat-number" id="stat-ok">0</div>
                            </div>
                            <div class="stat-box stat-error">
                                RECHAZADAS
                                <div class="stat-number" id="stat-error">0</div>
                            </div>
                        </div>

                        <div class="logs-container">
                            <div class="card">
                                <h3>‚úÖ Validaciones OK</h3>
                                <ul id="log-ok" class="log-list"></ul>
                            </div>
                            <div class="card">
                                <h3>‚ùå Rechazos</h3>
                                <ul id="log-reject" class="log-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resumen-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üìã Resumen de √ìrdenes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideResumen()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <input type="text" id="search-resumen" class="search-bar" placeholder="üîç Buscar orden..." oninput="filterResumen()">
                    <div style="overflow-x: auto;">
                        <table class="resumen-table">
                            <thead>
                                <tr>
                                    <th>Orden</th>
                                    <th>Total</th>
                                    <th>Validadas</th>
                                    <th>Progreso</th>
                                    <th>Destino</th>
                                    <th>Horario</th>
                                </tr>
                            </thead>
                            <tbody id="resumen-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="faltantes-module">
        <div class="container">
            <div class="main-content" style="max-width: 100%;">
                <div class="header">
                    <h1>üîç C√≥digos Faltantes</h1>
                    <button class="btn btn-secondary btn-small" onclick="hideFaltantes()">‚Üê Volver</button>
                </div>
                <div class="card">
                    <div class="faltantes-controls">
                        <select id="faltantes-order-select" onchange="renderFaltantes()">
                            <option value="">Seleccionar orden...</option>
                        </select>
                        <input type="text" id="search-faltantes" class="search-bar" placeholder="üîç Buscar c√≥digo..." oninput="filterFaltantes()">
                    </div>
                    <p style="margin-bottom: 15px;"><span style="color: var(--success);">‚úÖ Validados</span> | <span style="color: var(--error);">‚ùå Faltantes</span></p>
                    <div class="faltantes-grid" id="faltantes-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="popup-error" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('error')">√ó</button>
            <div class="popup-header" style="color: var(--error);">‚ùå C√ìDIGO RECHAZADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="err-code"></span><br>
                <strong>Motivo:</strong> <span id="err-reason" style="color: var(--error);"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('error')">Continuar</button>
            </div>
        </div>
    </div>

    <div id="popup-history" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('history')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è C√ìDIGO YA VALIDADO EN HISTORIAL</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="hist-code"></span><br>
                <strong>Orden Original:</strong> <span id="hist-obc"></span><br>
                <strong>Validado:</strong> <span id="hist-when"></span><br>
                <strong>Usuario:</strong> <span id="hist-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('history')">Cancelar</button>
                <button class="btn btn-primary" onclick="forceHistoryValidation()">Forzar Validaci√≥n con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-dup" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('dup')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚ö†Ô∏è DUPLICADO</div>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>C√≥digo:</strong> <span id="dup-code"></span><br>
                <strong>Validado:</strong> <span id="dup-when"></span><br>
                <strong>Usuario:</strong> <span id="dup-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('dup')">Ignorar</button>
                <button class="btn btn-primary" onclick="forceDuplicate()">Forzar con Nota</button>
            </div>
        </div>
    </div>

    <div id="popup-completed" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="continueViewing()">√ó</button>
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; font-weight: 700; color: var(--success); margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="completed-obc"></span><br>
                <strong>Cajas validadas:</strong> <span id="completed-count"></span><br>
                <strong>Usuario:</strong> <span id="completed-user"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="continueToNewOrder()" style="background: var(--warning);">Nueva Orden</button>
                <button class="btn btn-success" onclick="saveAndContinue()">Guardar y Continuar</button>
                <button class="btn btn-secondary" onclick="saveAndClose()">Cerrar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-manual" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-x" onclick="closePopup('manual')">√ó</button>
            <div class="popup-header" style="color: var(--warning);">‚úèÔ∏è INGRESO MANUAL DE C√ìDIGO</div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <p style="margin-bottom: 15px; color: #e65100;"><strong>‚ö†Ô∏è Advertencia:</strong> Solo usar para casos excepcionales</p>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>C√≥digo:</label>
                    <input type="text" id="manual-code" placeholder="Ingresa el c√≥digo">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Motivo:</label>
                    <select id="manual-reason" onchange="toggleManualOtherNote()">
                        <option value="">Seleccionar motivo...</option>
                        <option value="Codigo Borroso">C√≥digo Borroso</option>
                        <option value="Etiqueta Da√±ada">Etiqueta Da√±ada</option>
                        <option value="Error Surtido">Error Surtido</option>
                        <option value="Mercancia Reetiquetada">Mercanc√≠a Reetiquetada</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="input-group" id="manual-other-container" style="display: none;">
                    <label>Especificar motivo (obligatorio):</label>
                    <textarea id="manual-other-note" rows="3" placeholder="Describe el motivo..."></textarea>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="closePopup('manual')">Cancelar</button>
                <button class="btn btn-primary" onclick="submitManualCode()">Validar C√≥digo</button>
            </div>
        </div>
    </div>

    <div id="popup-reload-order" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--primary);">üì¶ ORDEN PARCIALMENTE VALIDADA</div>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0;">
                <strong>Orden:</strong> <span id="reload-obc"></span><br>
                <strong>Ya validadas:</strong> <span id="reload-validated"></span><br>
                <strong>Total:</strong> <span id="reload-total"></span><br>
                <strong>Pendientes:</strong> <span id="reload-pending"></span>
            </div>
            <p style="margin: 15px 0; color: #666;">Esta orden ya tiene validaciones previas. ¬øDeseas continuar donde se dej√≥?</p>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="cancelReloadOrder()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmReloadOrder()">Continuar Validaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="popup-already-complete" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--success);">‚úÖ ORDEN YA COMPLETADA</div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <div style="font-size: 1.8em; margin-bottom: 10px;">üéâ</div>
                <strong>Orden:</strong> <span id="complete-obc"></span><br>
                <strong>Validadas:</strong> <span id="complete-count"></span><br>
                <p style="margin-top: 10px; color: #666;">Esta orden ya fue validada al 100%</p>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closePopup('already-complete')">Entendido</button>
            </div>
        </div>
    </div>

    <div id="popup-daily-stats" class="popup-overlay">
        <div class="popup-content" style="max-width: 600px;">
            <button class="popup-close-x" onclick="closePopup('daily-stats')">√ó</button>
            <div class="popup-header" style="color: var(--success);">üìä Cajas Validadas Hoy (<span id="stats-date"></span>)</div>
            <p>Total global: <strong id="stats-total">0</strong></p>
            
            <h3 style="margin-top: 20px; color: var(--primary); font-size: 1.1em;">Estad√≠sticas por Usuario:</h3>
            <ul id="user-stats-list" class="user-stats-list">
                </ul>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        const CLIENT_ID = '1013623813866-70ovrtt690o.apps.googleusercontent.com'; // Placeholder
        const API_KEY = 'AIzaSyCh...'; // Placeholder
        const SPREADSHEET_ID = '1302Jb...'; // Placeholder
        const SPREADSHEET_BD = '1m_...'; // Placeholder
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let gapiInited = false;
        let gisOneloaded = false;

        let userProfile = null; // To store user email
        const BD_CODES = new Map(); // Normalized Code -> OBC
        const OBC_TOTALS = new Map(); // OBC -> Total Count
        const OBC_INFO = new Map(); // OBC -> { recipient, arrivalTime, referenceOrder }
        let HISTORY = new Map(); // Normalized Code -> { obc, when, user }

        // === GLOBAL STATE & PERSISTENCE (Modified) ===
        let STATE = {
            tabs: {},
            closedTabs: {},
            activeOBC: null
        };
        
        let SYNC_QUEUE = []; // New: Queue for offline validations
        let IS_ONLINE = navigator.onLine; // New: Connection status flag
        let IS_SHEETS_CONNECTED = false; // New: Sheets connection flag
        let LAST_SYNC_ATTEMPT = 0;
        const SYNC_INTERVAL_MS = 60 * 60 * 1000; // 1 hour for auto-retry

        let pendingReloadOBC = null;
        let lastScanned = null; // Stores data for duplicate/history popups

        const POPUPS = ['error', 'history', 'dup', 'completed', 'manual', 'reload-order', 'already-complete', 'daily-stats']; // Added 'daily-stats'

        function saveState() {
            try {
                const stateToSave = {
                    tabs: STATE.tabs,
                    closedTabs: STATE.closedTabs,
                    activeOBC: STATE.activeOBC,
                    history: Array.from(HISTORY.entries())
                };
                localStorage.setItem('wmsAppState', JSON.stringify(stateToSave));
                
                // NEW: Save Sync Queue separately
                localStorage.setItem('wmsSyncQueue', JSON.stringify(SYNC_QUEUE));
                
                updateSyncStatusDisplay(); // Update display after saving
            } catch (e) {
                console.error("Error saving state:", e);
                showNotification("Error al guardar datos localmente", 'error');
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('wmsAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    STATE.tabs = parsedState.tabs || {};
                    STATE.closedTabs = parsedState.closedTabs || {};
                    STATE.activeOBC = parsedState.activeOBC || null;
                    HISTORY = new Map(parsedState.history || []);
                }
                
                // NEW: Load Sync Queue
                const savedQueue = localStorage.getItem('wmsSyncQueue');
                if (savedQueue) {
                    SYNC_QUEUE = JSON.parse(savedQueue);
                    if (SYNC_QUEUE.length > 0) {
                        showNotification(`‚ö†Ô∏è Se recuperaron ${SYNC_QUEUE.length} validaciones pendientes.`, 'warning');
                    }
                }
                updateDashboardStats();
            } catch (e) {
                console.error("Error loading state:", e);
                showNotification("Error al cargar datos locales", 'error');
            }
        }

        // === GOOGLE AUTH & INIT ===
        // (Unchanged init functions, except for including initSync in initApp)
        
        function initApp() {
            loadState(); // Load state on startup
            renderValidation();
            updateConnectionIndicator();
            initSync(); // NEW: Initialize sync listeners and auto-retry
            // ... (rest of initApp)
        }
        
        // (handleAuthClick, gapiLoaded, gisLoaded, handleAuthClick, handleAuthResult, loadDatabase unchanged)

        // ... (existing handleAuthResult and gapiLoaded remain here)
        // ... (existing handleAuthClick and gisLoaded remain here)

        // === CONNECTION & SYNC MANAGER (New robust system) ===
        
        function updateConnectionIndicator() {
            const connEl = document.getElementById('status-conn');
            const labelEl = document.getElementById('conn-label');
            const sheetsEl = document.getElementById('status-sheets');
            const sheetsLabelEl = document.getElementById('sheets-label');

            if (IS_ONLINE) {
                connEl.className = 'status-indicator status-ok';
                labelEl.textContent = 'En l√≠nea';
            } else {
                connEl.className = 'status-indicator status-error';
                labelEl.textContent = 'Sin conexi√≥n';
            }
            
            if (IS_SHEETS_CONNECTED) {
                sheetsEl.className = 'status-indicator status-ok';
                sheetsLabelEl.textContent = 'Conectado';
            } else {
                sheetsEl.className = 'status-indicator status-error';
                sheetsLabelEl.textContent = 'Desconectado';
            }
        }
        
        function updateSyncStatus(connected = false) {
            IS_SHEETS_CONNECTED = connected;
            updateConnectionIndicator();
            updateStartButton();
            if (connected) {
                forceSync(); // Sync immediately after connecting/reconnecting
            }
        }

        function handleOnline() {
            IS_ONLINE = true;
            showNotification('‚úÖ Conexi√≥n restaurada', 'success');
            updateConnectionIndicator();
            if (IS_SHEETS_CONNECTED) {
                processSyncQueue();
            }
        }

        function handleOffline() {
            IS_ONLINE = false;
            showNotification('‚ö†Ô∏è Sin conexi√≥n - guardando localmente', 'warning');
            updateConnectionIndicator();
            updateSyncStatusDisplay();
        }
        
        function updateSyncStatusDisplay(isSyncError = false) {
            const statusElSidebar = document.getElementById('sync-status-sidebar');
            const statusElDashboard = document.getElementById('status-sync');
            const labelElDashboard = document.getElementById('sync-label');
            const syncBtn = document.getElementById('manual-sync-btn');
            
            const pendingCount = SYNC_QUEUE.length;

            let statusClass = 'sync-ok';
            let statusText = '‚úÖ Sincronizado';
            let dashboardLabel = 'Sincronizado';
            
            if (isSyncError) {
                statusClass = 'sync-error';
                statusText = `‚ùå Error de Sincro. (${pendingCount})`;
                dashboardLabel = 'Error (Rojo)';
            } else if (pendingCount > 0) {
                statusClass = 'sync-warning';
                statusText = `‚ö†Ô∏è Pendiente (${pendingCount})`;
                dashboardLabel = `Pendiente (${pendingCount})`;
            } else if (!IS_ONLINE) {
                statusClass = 'sync-offline';
                statusText = '‚ö†Ô∏è Sin conexi√≥n';
                dashboardLabel = 'Sin conexi√≥n (Naranja)';
            }

            statusElSidebar.className = `sync-status ${statusClass}`;
            statusElSidebar.innerHTML = statusText;
            statusElSidebar.style.display = 'block';

            // Dashboard indicator update
            if (statusClass === 'sync-ok') {
                statusElDashboard.className = 'status-indicator status-ok';
            } else if (statusClass === 'sync-offline' || statusClass === 'sync-warning') {
                statusElDashboard.className = 'status-indicator';
                statusElDashboard.style.backgroundColor = 'var(--warning)';
            } else if (statusClass === 'sync-error') {
                statusElDashboard.className = 'status-indicator status-error';
            }
            labelElDashboard.textContent = dashboardLabel;
            
            // Toggle manual sync button visibility
            syncBtn.style.display = (pendingCount > 0 && IS_ONLINE && IS_SHEETS_CONNECTED) ? 'block' : 'none';
        }

        async function processSyncQueue() {
            if (!IS_ONLINE || !IS_SHEETS_CONNECTED || SYNC_QUEUE.length === 0) {
                updateSyncStatusDisplay(false);
                return;
            }
            
            const count = SYNC_QUEUE.length;
            showNotification(`üîÑ Sincronizando ${count} validaciones pendientes...`, 'info');
            
            // Create the batch for Google Sheets append
            const batch = SYNC_QUEUE.map(d => [d.obc, d.code, d.normalizedCode, d.user, d.date, d.time, d.location, d.note]);
            
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Validaciones!A:G',
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: batch }
                });
                
                // On success: Clear queue, update local history (for real-time dup check), show success
                SYNC_QUEUE.length = 0; // Clear the queue
                saveState(); // Persist the empty queue
                
                // Update history map with the synced items
                // This is generally redundant if loadDatabase loads ALL history, but good practice for real-time update
                batch.forEach(item => {
                    const [obc, , normalizedCode, user, date] = item;
                    HISTORY.set(normalizedCode, { obc, when: date, user });
                });

                showNotification(`‚úÖ Sincronizaci√≥n de ${count} validaciones completada.`, 'success');
                updateSyncStatusDisplay(false); // Sincronizado (Green)
                updateDashboardStats(); // Update dashboard count
                LAST_SYNC_ATTEMPT = Date.now();
                
            } catch (e) {
                console.error('Error during queue processing:', e);
                const errorMessage = e.result?.error?.message || 'Error desconocido de Google Sheets.';
                showNotification(`‚ùå Error de sincronizaci√≥n: ${errorMessage}`, 'error');
                updateSyncStatusDisplay(true); // Error state (Red)
            }
        }
        
        function forceSync() {
            if (!IS_ONLINE) {
                showNotification('‚ö†Ô∏è No hay conexi√≥n a internet para sincronizar.', 'warning');
                return;
            }
            if (!IS_SHEETS_CONNECTED) {
                showNotification('‚ö†Ô∏è Con√©ctate a Google Sheets para sincronizar.', 'warning');
                return;
            }
            if (SYNC_QUEUE.length === 0) {
                showNotification('‚ÑπÔ∏è No hay validaciones pendientes para sincronizar.', 'info');
                return;
            }
            processSyncQueue();
        }

        function initSync() {
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            IS_ONLINE = navigator.onLine; // Set initial status
            updateConnectionIndicator();
            
            // Auto-retry every hour
            setInterval(() => {
                if (IS_ONLINE && IS_SHEETS_CONNECTED && SYNC_QUEUE.length > 0) {
                    processSyncQueue();
                }
            }, SYNC_INTERVAL_MS);
        }
        
        // === DATABASE LOADING ===
        // (loadDatabase remains here, just needs to call updateSyncStatus(true) on success)
        async function loadDatabase() {
            if (!gapi.client.getToken()) {
                showNotification('Conecta primero con Google Sheets', 'warning');
                return;
            }
            showNotification('Cargando base de datos...', 'info');
            try {
                // Load Resumen
                const resRes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_BD,
                    range: 'Resumen!A:E'
                });
                const resRows = resRes.result.values;
                if (resRows?.length > 1) {
                    OBC_TOTALS.clear();
                    OBC_INFO.clear();
                    for (let i = 1; i < resRows.length; i++) {
                        const [obc, ref, time, recipient, count] = resRows[i];
                        if (obc && count) {
                            OBC_TOTALS.set(obc, parseInt(count));
                            OBC_INFO.set(obc, { recipient, arrivalTime: time, referenceOrder: ref });
                        }
                    }
                }
                
                // Load BD codes
                const sheets = ['BD', 'Outbound_Âá∫Â∫ìÂçï', 'Sheet1'];
                for (const sheet of sheets) {
                    try {
                        const codesRes = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_BD,
                            range: `${sheet}!A:I`
                        });
                        const rows = codesRes.result.values;
                        if (rows?.length > 1) {
                            for (let i = 1; i < rows.length; i++) {
                                const [obc, code] = rows[i];
                                if (obc && code) {
                                    BD_CODES.set(normalizeCode(code), obc.toUpperCase().trim());
                                }
                            }
                        }
                    } catch (e) {
                        console.warn(`Could not load sheet ${sheet}:`, e);
                    }
                }
                
                // Load History from Validaciones sheet (Optional but recommended for cross-device consistency)
                const historyRes = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Validaciones!C:E' // NormalizedCode, User, Date
                });
                const historyRows = historyRes.result.values;
                if (historyRows?.length > 1) {
                    HISTORY.clear();
                    for (let i = 1; i < historyRows.length; i++) {
                        const [normalizedCode, user, date] = historyRows[i];
                        if (normalizedCode) {
                            // Assuming OBC is also retrieved if needed, but for simple history check, this is enough
                            HISTORY.set(normalizedCode, { obc: 'N/A', when: date, user });
                        }
                    }
                }

                showNotification(`‚úÖ Base de datos cargada: ${BD_CODES.size.toLocaleString()} c√≥digos.`, 'success');
                document.getElementById('bd-label').textContent = 'Cargada';
                document.getElementById('status-bd').className = 'status-indicator status-ok';
                updateSyncStatus(true); // Sheets is connected
                updateDashboardStats();
            } catch (e) {
                console.error('Error cargando BD:', e);
                showNotification('‚ùå Error cargando base de datos', 'error');
                document.getElementById('bd-label').textContent = 'Error';
                document.getElementById('status-bd').className = 'status-indicator status-error';
                updateSyncStatus(true); // Still connected to Sheets, but failed to load data
            }
        }

        function updateDashboardStats() {
            document.getElementById('dash-bd').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('bd-count-sidebar').textContent = BD_CODES.size.toLocaleString();
            document.getElementById('dash-orders').textContent = OBC_TOTALS.size || '0';
            
            // NEW: Calculate total validated *today*
            const today = new Date().toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' });
            let totalValidatedToday = 0;
            
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            
            for (const obc in allOrders) {
                totalValidatedToday += allOrders[obc].validations.filter(v => {
                    // Use the reliable fullTimestamp for date comparison
                    const validationDate = new Date(v.fullTimestamp);
                    return validationDate.toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' }) === today;
                }).length;
            }
            
            // Add pending queue count to the total for the dashboard (since they are locally saved)
            totalValidatedToday += SYNC_QUEUE.length;

            document.getElementById('dash-validated').textContent = totalValidatedToday || '0';
        }

        // === CODE EXTRACTION, NORMALIZE, VALIDATION LOGIC ===
        // (extractCode, normalizeCode, setupListeners remain here)

        // === VALIDATION LOGIC (Modified to support offline and correct timestamp) ===
        
        async function handleValidation(raw) {
            // ... (existing logic: check location, extractCode, normalizeCode)
            // ...
            
            // Check current session
            const isDup = tab.validations.find(v => v.code === normalized);
            if (isDup) {
                lastScanned = { raw, code: normalized, obc: activeOBC, location: tab.location, duplicate: isDup, isManual: false };
                showPopup('dup', normalized, isDup);
                playSound('duplicate');
                return;
            }
            
            await handleValidationOK(raw, normalized, activeOBC, tab.location, '', false);
        }

        async function handleValidationOK(raw, code, obc, location, note = '', isManual = false) {
            const tab = STATE.tabs[obc];
            
            // Use a single Date object for reliability
            const now = new Date(); 
            
            // Correctly format date and time using local timezone (Mexico City)
            const dateStr = now.toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' });
            const timeStr = now.toLocaleTimeString('es-MX', { timeZone: 'America/Mexico_City', hour12: false });
            const fullTimestampStr = now.toISOString(); // Reliable ISO for local calculation later

            const finalNote = isManual && note ? `Codigo Escrito Manualmente: ${note}` : note;
            
            const log = {
                id: now.getTime(),
                timestamp: timeStr, // Corrected time
                date: dateStr,      // Corrected date
                fullTimestamp: fullTimestampStr, // New field
                user: tab.user,
                obc: obc,
                rawCode: raw,
                code: code,
                normalized: normalizeCode(code),
                location: location || tab.location,
                note: finalNote,
                isManual: isManual
            };
            
            // 1. Prepare data for sheets (Sync Data)
            const syncData = {
                obc,
                code: log.code,
                normalizedCode: log.normalized,
                user: log.user,
                date: log.date,
                time: log.timestamp,
                location: log.location,
                note: log.note
            };

            // 2. Add to local log and save state
            tab.validations.push(log);
            saveState(); // Persist local changes (log and maybe sync queue)
            renderProgress(obc);
            updateDashboardStats();
            playSound('ok');

            // 3. Sync Logic: Immediate or Queue
            if (IS_ONLINE && IS_SHEETS_CONNECTED) {
                try {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Validaciones!A:G',
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [[syncData.obc, syncData.code, syncData.normalizedCode, syncData.user, syncData.date, syncData.time, syncData.location, syncData.note]] }
                    });
                    
                    // Update BD HISTORY for real-time check
                    HISTORY.set(syncData.normalizedCode, { obc: syncData.obc, when: syncData.date, user: syncData.user });
                    showNotification('‚úÖ Validaci√≥n sincronizada', 'success');
                } catch (error) {
                    console.error('Error syncing validation immediately:', error);
                    // ONLINE but FAILED: Add to queue for retry
                    SYNC_QUEUE.push(syncData);
                    saveState();
                    showNotification('‚ùå Error al sincronizar. Guardado en cola de pendientes.', 'error');
                    updateSyncStatusDisplay(true); // Set status to error
                }
            } else {
                // OFFLINE: Add to sync queue
                SYNC_QUEUE.push(syncData);
                saveState(); // Persist queue
                showNotification(`‚ö†Ô∏è Sin conexi√≥n - guardando localmente (${SYNC_QUEUE.length} pendientes)`, 'warning');
                updateSyncStatusDisplay(false); // Set status to offline/warning
            }

            // ... (rest of the original logic, like checking for completion)
            if (tab.validations.length >= total) {
                showCompletedPopup(obc, total, tab.user);
            }
        }
        
        // ... (handleValidationReject remains here)

        // === POPUP FUNCTIONS (Added openDailyStatsPopup) ===

        function openDailyStatsPopup() {
            const today = new Date().toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' });
            
            // 1. Calculate stats from STATE (tabs, closedTabs) and SYNC_QUEUE
            const allValidations = [];
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            
            for (const obc in allOrders) {
                allValidations.push(...allOrders[obc].validations);
            }
            
            // Include queued items (use current time as approximation for the date)
            const queuedValidations = SYNC_QUEUE.map(d => ({ 
                user: d.user, 
                fullTimestamp: new Date().toISOString() // Fallback to current time
            }));
            allValidations.push(...queuedValidations);
            
            // 2. Filter for today's validations and calculate per-user totals
            const userTotals = new Map();
            const todayValidations = allValidations.filter(v => {
                const validationDate = new Date(v.fullTimestamp || new Date().toISOString()); 
                return validationDate.toLocaleDateString('es-MX', { timeZone: 'America/Mexico_City' }) === today;
            });
            
            let globalTotal = todayValidations.length;
            
            todayValidations.forEach(v => {
                const user = v.user || 'Desconocido';
                userTotals.set(user, (userTotals.get(user) || 0) + 1);
            });
            
            // 3. Render the list
            const listEl = document.getElementById('user-stats-list');
            listEl.innerHTML = '';
            
            document.getElementById('stats-date').textContent = today;
            document.getElementById('stats-total').textContent = globalTotal;

            if (globalTotal === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #666;">No hay cajas validadas hoy.</p>';
            } else {
                const sortedUsers = Array.from(userTotals.entries()).sort((a, b) => b[1] - a[1]);
                
                sortedUsers.forEach(([user, count]) => {
                    const percentage = ((count / globalTotal) * 100).toFixed(1);
                    
                    const li = document.createElement('li');
                    li.className = 'user-stat-item';
                    
                    // Create bar chart structure
                    li.innerHTML = `
                        <div class="user-stat-header">
                            <span>${user}</span>
                            <span>${count}</span>
                        </div>
                        <div class="user-stat-bar-container">
                            <div class="user-stat-bar-fill" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
            }

            showPopup('daily-stats');
        }

        // (showPopup, closePopup, etc. remain here)
        // ... (The rest of the JS code remains the same, like tab functions, exportData, etc.)

        // Update exportData to include SYNC_QUEUE in the export
        function exportData() {
            const rows = [];
            rows.push('Fecha,Hora,Usuario,Orden,C√≥digo,Ubicaci√≥n,Nota');
            
            const allOrders = { ...STATE.tabs, ...STATE.closedTabs };
            for (const obc in allOrders) {
                allOrders[obb].validations.forEach(log => {
                    rows.push(`${log.date},${log.timestamp},${log.user},${log.obc},${log.code},${log.location || ''},${log.note || ''}`);
                });
            }
            
            // Include SYNC_QUEUE data in export with a special note
            SYNC_QUEUE.forEach(log => {
                // Use data from the sync log itself
                rows.push(`${log.date},${log.time},${log.user},${log.obc},${log.code},${log.location || ''},PENDIENTE SYNC - ${log.note || 'N/A'}`);
            });
            
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `validaciones_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            showNotification('üì• Datos exportados', 'success');
        }

        // Ensure initApp calls the new initSync
        function initApp() {
            // ... existing code
            loadState();
            renderValidation();
            updateConnectionIndicator();
            initSync();
            // ...
        }

        // Call initApp at the end
        window.onload = initApp;

    </script>
</body>
</html>
