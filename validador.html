<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validaci√≥n WMS</title>
    <meta name="theme-color" content="#ed5224">
    <style>
        :root {
            --primary-color: #ed5224;
            --secondary-color: #333;
            --background-color: #f7f7f7;
            --text-color: #333;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--background-color); 
            display: flex; 
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            display: flex;
            width: 100%;
        }

        .sidebar { 
            width: 280px; 
            background-color: var(--secondary-color); 
            color: white; 
            padding: 20px; 
            flex-shrink: 0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .main-content { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 { 
            color: var(--primary-color); 
            font-size: 1.8em;
        }

        .card { 
            background-color: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
        }
        
        .btn { 
            padding: 12px 18px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }

        .btn-primary:hover { 
            background-color: #c94017; 
        }

        .btn-secondary { 
            background-color: #6c757d; 
            color: white; 
        }

        .btn-google { 
            background-color: #4285F4;
            color: white; 
            width: 100%;
            margin-bottom: 15px; 
        }
        
        .input-group { 
            margin-bottom: 15px;
        }

        .input-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            font-size: 0.9em; 
        }

        .input-group input, .input-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .scanner-input { 
            font-size: 1.8em !important; 
            text-transform: uppercase; 
            font-weight: bold;
            padding: 15px !important;
            text-align: center;
            border: 3px solid #ddd !important;
        }

        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .stat-box { 
            text-align: center; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .stat-box:hover {
            transform: translateY(-2px);
        }

        .stat-ok { 
            background-color: #e8f5e9; 
            border: 2px solid var(--success-color); 
            color: var(--success-color);
        }

        .stat-error { 
            background-color: #ffebee; 
            border: 2px solid var(--error-color); 
            color: var(--error-color);
        }

        .stat-rate { 
            background-color: #e3f2fd; 
            border: 2px solid var(--primary-color); 
            color: var(--primary-color);
        }

        .stat-number { 
            font-size: 2.2em; 
            font-weight: 700; 
            margin-top: 5px;
            color: var(--text-color);
        }

        .tab-bar { 
            display: flex; 
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab { 
            padding: 10px 18px; 
            cursor: pointer; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            background-color: #fff; 
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }

        .tab.active { 
            background-color: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color);
        }

        .tab:hover:not(.active) {
            background-color: #f0f0f0;
            transform: translateY(-1px);
        }

        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            opacity: 0.7;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .logs-container { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; 
        }
        
        .log-section h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .log-list { 
            max-height: 400px; 
            overflow-y: auto; 
            list-style: none; 
            font-size: 0.9em; 
            background: #fafafa;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }

        .log-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px; 
            margin-bottom: 8px;
            border-radius: 4px;
            background: white;
            align-items: center;
            transition: transform 0.1s;
        }

        .log-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .log-ok { 
            border-left: 4px solid var(--success-color); 
        }
        
        .log-reject { 
            border-left: 4px solid var(--error-color); 
        }

        .log-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .log-code {
            font-weight: 600;
            font-size: 1.05em;
        }

        .log-meta {
            font-size: 0.85em;
            color: #666;
        }

        .btn-edit {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .btn-edit:hover {
            background-color: #f0f0f0;
        }

        .connection-status {
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: center;
        }

        .status-connected {
            background-color: #e8f5e9;
            color: var(--success-color);
        }

        .status-disconnected {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .status-error {
            background-color: #ffebee;
            color: var(--error-color);
        }
        
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%;
            max-width: 500px; 
            text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .popup-header { 
            font-size: 1.6em; 
            margin-bottom: 20px; 
            font-weight: 700; 
        }

        .popup-details { 
            text-align: left; 
            margin-bottom: 20px; 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: var(--border-radius);
            line-height: 1.6;
        }
        
        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #555;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .sidebar h3 {
            margin-bottom: 10px;
            font-size: 1em;
            opacity: 0.9;
        }

        .bd-info {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
        }

        .bd-count {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .obc-list-item {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 968px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .logs-container {
                grid-template-columns: 1fr;
            }

            .tab-bar {
                justify-content: center;
            }
        }

        .flash-success {
            animation: flashSuccess 0.3s;
        }

        .flash-error {
            animation: flashError 0.3s;
        }

        @keyframes flashSuccess {
            0%, 100% { border-color: #ddd; }
            50% { border-color: var(--success-color); background-color: #e8f5e9; }
        }

        @keyframes flashError {
            0%, 100% { border-color: #ddd; }
            50% { border-color: var(--error-color); background-color: #ffebee; }
        }

        .user-select-wrapper {
            position: relative;
        }

        .user-select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-section">
                <h2>üè≠ WMS Validator</h2>
                <button id="auth-button" class="btn btn-google">
                    üîó Conectar con Google Sheets
                </button>
                <div id="auth-status" class="connection-status status-disconnected">
                    Desconectado ‚ö†Ô∏è
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üìä Base de Datos</h3>
                <div class="bd-info">
                    <div class="bd-count" id="bd-count">0</div>
                    <div style="font-size: 0.85em; opacity: 0.8;">c√≥digos cargados</div>
                </div>
                <button class="btn btn-primary" onclick="loadDatabase()" style="width: 100%;">
                    üîÑ Recargar BD
                </button>
            </div>

            <div class="sidebar-section">
                <h3>üë§ Usuario Activo</h3>
                <div class="user-select-wrapper">
                    <select id="user-select" onchange="updateGlobalState()">
                    </select>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>üì¶ OBCs Activas</h3>
                <div id="obc-list"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>üîç Sistema de Validaci√≥n</h1>
                <button class="btn btn-secondary" onclick="exportData()">
                    üì• Exportar CSV
                </button>
            </div>

            <div id="tab-bar" class="tab-bar"></div>

            <div id="validation-area">
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>üë§ Usuario:</label>
                            <input type="text" id="active-user-display" disabled>
                        </div>
                        <div class="input-group">
                            <label>üì¶ OBC Activa:</label>
                            <input type="text" id="active-obc-display" disabled>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="global-location">üìç Ubicaci√≥n Global (Opcional):</label>
                        <input type="text" id="global-location" placeholder="Ej: PLEC123, 4971098/1" onchange="updateGlobalState()">
                    </div>
                    
                    <hr style="margin: 20px 0; border: none; border-top: 2px dashed #ddd;">
                    
                    <div class="input-group">
                        <label for="scanner-input" style="font-size: 1.2em; color: var(--primary-color);">
                            üì∑ ESCANEAR C√ìDIGO (Presiona Enter):
                        </label>
                        <input type="text" id="scanner-input" class="scanner-input" autofocus placeholder="Escanea aqu√≠...">
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-box stat-ok">
                        ‚úÖ VALIDADAS OK
                        <div class="stat-number" id="validated-count">0</div>
                    </div>
                    <div class="stat-box stat-error">
                        ‚ùå RECHAZADAS
                        <div class="stat-number" id="rejected-count">0</div>
                    </div>
                    <div class="stat-box stat-rate">
                        üìä TASA ERROR
                        <div class="stat-number" id="error-rate">0.0%</div>
                    </div>
                </div>

                <div class="logs-container">
                    <div class="log-section card">
                        <h3>‚úÖ √öltimas Validaciones OK</h3>
                        <ul id="ok-logs" class="log-list"></ul>
                    </div>
                    <div class="log-section card">
                        <h3>‚ùå Rechazos Recientes</h3>
                        <ul id="reject-logs" class="log-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <div id="error-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--error-color);">
                ‚ùå VALIDACI√ìN RECHAZADA
            </div>
            <div class="popup-details">
                <strong>C√≥digo:</strong> <span id="error-code"></span><br>
                <strong>OBC:</strong> <span id="error-obc"></span><br>
                <strong>Motivo:</strong> <span id="error-reason" style="color: var(--error-color);"></span>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="closeErrorPopup()">
                    Continuar Escaneando
                </button>
            </div>
        </div>
    </div>

    <div id="duplicate-popup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--warning-color);">
                ‚ö†Ô∏è CAJA YA VALIDADA
            </div>
            <div class="popup-details">
                <strong>C√≥digo:</strong> <span id="dup-code"></span><br>
                <strong>OBC:</strong> <span id="dup-obc"></span><br>
                <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                <strong>Validada anteriormente:</strong><br>
                ‚Ä¢ <span id="dup-timestamp"></span><br>
                ‚Ä¢ Usuario: <span id="dup-user"></span><br>
                ‚Ä¢ Ubicaci√≥n: <span id="dup-location"></span>
            </div>
            <p style="margin: 15px 0; font-weight: 600;">¬øQu√© deseas hacer?</p>
            <div class="popup-buttons">
                <button class="btn btn-secondary" onclick="handleDuplicateAction('ignore')">
                    Ignorar - No guardar
                </button>
                <button class="btn btn-primary" onclick="showForcedNoteModal()">
                    Forzar entrada con nota
                </button>
            </div>
        </div>
    </div>

    <div id="forced-note-modal" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header" style="color: var(--primary-color);">
                üìù Forzar Duplicado
            </div>
            <p style="margin-bottom: 15px;">A√±ade una nota para justificar el duplicado:</p>
            <input type="text" id="forced-note-input" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px;" placeholder="Ej: Cambio de ubicaci√≥n por error de pickeo">
            <div class="popup-buttons">
                <button class="btn btn-primary" onclick="handleDuplicateAction('force')">
                    üíæ Guardar Forzado
                </button>
                <button class="btn btn-secondary" onclick="closeForcedNoteModal()">
                    ‚Üê Volver
                </button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CLIENT_ID = '1013623813866-70ovrtt690fbka3a97h4fenpp54hm7j8.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1gU5yDb0R4_Mf1fE-lOA7vwYmTUBR0wV7EPGg5zUt2Xo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        const VALIDATORS = ['MIGUEL', 'PEDRO', 'ALEJANDRO', 'ESMERALDA', 'KATERYNE'];
        const STORAGE_KEY_PREFIX = 'wms_validation_';

        // ==================== ESTADO GLOBAL ====================
        let BD_CODES = new Set();
        let GLOBAL_STATE = {
            activeOBC: 'OBC_DEFAULT_1',
            tabs: {
                'OBC_DEFAULT_1': {
                    user: 'MIGUEL',
                    location: '',
                    validations: [],
                    rejections: []
                }
            }
        };
        let lastScannedCode = null;
        let TOKEN_CLIENT;
        let audioContext;

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initAudio();
            await loadFromStorage();
            setupEventListeners();
            populateUserSelect();
            renderApp();
            
            // Inicializar Google API
            gapi.load('client', initGoogleAPI);
        });

        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn('Web Audio API no disponible');
            }
        }

        async function initGoogleAPI() {
            try {
                await gapi.client.init({
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });

                TOKEN_CLIENT = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse,
                });

                updateAuthStatus(false);
            } catch (error) {
                console.error("Error al inicializar GAPI:", error);
                showNotification('Error al inicializar Google API', 'error');
            }
        }

        function handleAuthResponse(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                gapi.client.setToken(tokenResponse);
                updateAuthStatus(true);
                loadDatabase();
            } else {
                updateAuthStatus(false);
            }
        }

        // ==================== PERSISTENCIA CON WINDOW.STORAGE ====================
        async function loadFromStorage() {
            try {
                // Cargar estado principal
                const stateResult = await window.storage.get(`${STORAGE_KEY_PREFIX}state`);
                if (stateResult && stateResult.value) {
                    const parsedState = JSON.parse(stateResult.value);
                    // Asegurar que todos los tabs tengan arrays
                    for (const obc in parsedState.tabs) {
                        parsedState.tabs[obc].validations = parsedState.tabs[obc].validations || [];
                        parsedState.tabs[obc].rejections = parsedState.tabs[obc].rejections || [];
                    }
                    GLOBAL_STATE = parsedState;
                }

                // Cargar BD cach√©
                const bdResult = await window.storage.get(`${STORAGE_KEY_PREFIX}bd_cache`);
                if (bdResult && bdResult.value) {
                    const cached = JSON.parse(bdResult.value);
                    BD_CODES = new Set(cached.codes);
                    document.getElementById('bd-count').textContent = BD_CODES.size.toLocaleString();
                }
            } catch (error) {
                console.log('Primera carga o storage no disponible:', error);
            }
        }

        async function saveState() {
            try {
                await window.storage.set(
                    `${STORAGE_KEY_PREFIX}state`,
                    JSON.stringify(GLOBAL_STATE)
                );
            } catch (error) {
                console.error('Error al guardar estado:', error);
            }
        }

        async function saveBDCache() {
            try {
                await window.storage.set(
                    `${STORAGE_KEY_PREFIX}bd_cache`,
                    JSON.stringify({
                        codes: Array.from(BD_CODES),
                        timestamp: new Date().toISOString()
                    })
                );
            } catch (error) {
                console.error('Error al guardar cach√© de BD:', error);
            }
        }

        // ==================== AUTENTICACI√ìN ====================
        function updateAuthStatus(isSignedIn) {
            const statusElement = document.getElementById('auth-status');
            const button = document.getElementById('auth-button');
            
            if (isSignedIn) {
                statusElement.textContent = "‚úÖ Conectado";
                statusElement.className = "connection-status status-connected";
                button.textContent = "üîì Cerrar Sesi√≥n";
            } else {
                statusElement.textContent = "‚ö†Ô∏è Desconectado";
                statusElement.className = "connection-status status-disconnected";
                button.textContent = "üîó Conectar con Google Sheets";
            }
        }

        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                TOKEN_CLIENT.requestAccessToken();
            } else {
                google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                    gapi.client.setToken(null);
                    updateAuthStatus(false);
                    showNotification('Sesi√≥n cerrada. Datos guardados localmente.', 'info');
                });
            }
        }

        document.getElementById('auth-button').onclick = handleAuthClick;

        // ==================== CARGA DE BASE DE DATOS ====================
        async function loadDatabase() {
            if (!gapi.client.getToken()) {
                showNotification('Primero debes conectar con Google Sheets', 'warning');
                return;
            }

            const countElement = document.getElementById('bd-count');
            countElement.innerHTML = 'Cargando... <span class="loading"></span>';

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'BD!I:I',
                });

                const codes = response.result.values;
                if (codes) {
                    const dbCodes = new Set(
                        codes.flat()
                            .map(code => code ? normalizeCode(code) : '')
                            .filter(code => code !== '')
                    );
                    
                    BD_CODES = dbCodes;
                    countElement.textContent = BD_CODES.size.toLocaleString();
                    
                    // Guardar cach√©
                    await saveBDCache();
                    
                    showNotification(`‚úÖ BD cargada: ${BD_CODES.size.toLocaleString()} c√≥digos`, 'success');
                    playAudio('ok');
                }
            } catch (err) {
                console.error('Error al cargar BD:', err);
                countElement.textContent = '0 (Error)';
                showNotification('‚ùå Error al cargar BD. Verifica permisos y conexi√≥n.', 'error');
            }
        }

        // ==================== EXTRACCI√ìN Y NORMALIZACI√ìN ====================
        function normalizeCode(code) {
            return code ? code.replace(/-/g, '/').toLowerCase().trim() : '';
        }

        function extractCode(rawCode) {
            const code = rawCode.trim();
            
            // Patrones de formato JSON
            const pattern1 = '¬®id¬®√± ¬®';
            const pattern2 = '[ID[√± [';
            
            // Intento de extracci√≥n por Formato JSON
            if (code.includes(pattern1)) {
                const startIndex = code.indexOf(pattern1) + pattern1.length;
                const endIndex = code.indexOf('¬®,', startIndex);
                if (endIndex !== -1) {
                    return code.substring(startIndex, endIndex).trim();
                }
            } else if (code.includes(pattern2)) {
                const startIndex = code.indexOf(pattern2) + pattern2.length;
                const endIndex = code.indexOf('[,', startIndex);
                if (endIndex !== -1) {
                    return code.substring(startIndex, endIndex).trim();
                }
            }
            
            return code;
        }

        // ==================== L√ìGICA DE VALIDACI√ìN ====================
        function setupEventListeners() {
            const input = document.getElementById('scanner-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value.trim() !== '') {
                    e.preventDefault();
                    processScan(input.value.trim());
                    input.value = '';
                }
            });
        }

        async function processScan(rawCode) {
            if (BD_CODES.size === 0) {
                showNotification('‚ö†Ô∏è La Base de Datos no ha sido cargada', 'warning');
                playAudio('error');
                return;
            }

            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];
            const user = tab.user;
            const location = tab.location;
            
            lastScannedCode = { rawCode, extracted: null, obc: activeOBC, user, location };

            const extractedCode = extractCode(rawCode);
            const normalizedCode = normalizeCode(extractedCode);
            lastScannedCode.extracted = normalizedCode;

            // 1. Buscar en BD
            if (!BD_CODES.has(normalizedCode)) {
                await handleRejection('NO_EXISTE_EN_BD', rawCode, normalizedCode, activeOBC);
                return;
            }

            // 2. Verificar Duplicados
            const isDuplicate = tab.validations.find(v => 
                v.extractedCode === normalizedCode && v.obc === activeOBC
            );

            if (isDuplicate) {
                lastScannedCode.duplicateOf = isDuplicate;
                showDuplicatePopup(normalizedCode, activeOBC, isDuplicate);
                playAudio('duplicate');
                return;
            }
            
            // 3. Validar OK
            await handleValidationOK(rawCode, extractedCode, normalizedCode, activeOBC, user, location);
        }

        async function handleValidationOK(rawCode, extractedCode, normalizedCode, obc, user, location, note = '') {
            const tab = GLOBAL_STATE.tabs[obc];
            const now = new Date();
            
            const newLog = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                date: now.toISOString().slice(0, 10),
                user,
                obc,
                originalCode: rawCode,
                extractedCode: normalizedCode,
                location,
                note
            };
            
            tab.validations.unshift(newLog);
            playAudio('ok');
            flashInput('success');
            renderLogs();
            await saveState();

            // Escritura a Google Sheets
            if (gapi.client.getToken()) {
                await saveValidationLog('Val3', newLog);
            }
        }

        async function handleRejection(reason, rawCode, normalizedCode, obc) {
            const tab = GLOBAL_STATE.tabs[obc];
            const now = new Date();
            
            const newLog = {
                id: now.getTime(),
                timestamp: now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                date: now.toISOString().slice(0, 10),
                user: tab.user,
                obc,
                codeScanned: rawCode,
                extractedCode: normalizedCode,
                rejectionReason: reason,
            };
            
            tab.rejections.unshift(newLog);
            playAudio('error');
            flashInput('error');
            showErrorPopup(normalizedCode, obc, reason);
            renderLogs();
            await saveState();

            // Escritura a Google Sheets
            if (gapi.client.getToken()) {
                await saveValidationLog('Validaciones_RECHAZADAS', newLog);
            }
        }

        // ==================== ESCRITURA A GOOGLE SHEETS ====================
        async function saveValidationLog(sheetName, logRecord) {
            if (!gapi.client.getToken()) {
                return;
            }
            
            const range = `${sheetName}!A1`;
            let values = [];

            if (sheetName.startsWith('Val')) {
                values = [[
                    logRecord.date,
                    logRecord.timestamp,
                    logRecord.user,
                    logRecord.obc,
                    logRecord.extractedCode,
                    logRecord.location,
                    logRecord.note
                ]];
            } else if (sheetName.includes('RECHAZADAS')) {
                values = [[
                    logRecord.date,
                    logRecord.timestamp,
                    logRecord.user,
                    logRecord.obc,
                    logRecord.codeScanned,
                    logRecord.rejectionReason,
                    logRecord.extractedCode
                ]];
            }

            if (values.length === 0) return;

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values }
                });
            } catch (err) {
                console.error(`Error al escribir en ${sheetName}:`, err);
            }
        }

        // ==================== RENDERIZADO ====================
        function updateGlobalState() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];

            tab.user = document.getElementById('user-select').value;
            tab.location = document.getElementById('global-location').value.toUpperCase().trim();
            
            document.getElementById('active-user-display').value = tab.user;
            document.getElementById('active-obc-display').value = activeOBC;

            saveState();
        }

        function switchOBC(obc) {
            GLOBAL_STATE.activeOBC = obc;
            renderApp();
            saveState();
        }

        function addOBC() {
            const newOBC = prompt("Ingresa el n√∫mero de la nueva OBC (Ej: OBC31251120RV):");
            if (!newOBC) return;
            
            const obcName = newOBC.toUpperCase().trim();
            if (obcName && !GLOBAL_STATE.tabs[obcName]) {
                GLOBAL_STATE.tabs[obcName] = {
                    user: GLOBAL_STATE.tabs[GLOBAL_STATE.activeOBC].user,
                    location: '',
                    validations: [],
                    rejections: []
                };
                switchOBC(obcName);
                showNotification(`‚úÖ OBC ${obcName} creada`, 'success');
            }
        }

        function removeOBC(obc) {
            const obcKeys = Object.keys(GLOBAL_STATE.tabs);
            if (obcKeys.length <= 1) {
                showNotification('‚ö†Ô∏è Debe haber al menos una OBC activa', 'warning');
                return;
            }

            if (confirm(`¬øEliminar OBC ${obc}? Los datos se mantendr√°n en el storage.`)) {
                delete GLOBAL_STATE.tabs[obc];
                
                if (GLOBAL_STATE.activeOBC === obc) {
                    GLOBAL_STATE.activeOBC = Object.keys(GLOBAL_STATE.tabs)[0];
                }
                
                renderApp();
                saveState();
                showNotification(`OBC ${obc} eliminada`, 'info');
            }
        }

        function renderApp() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];

            // Renderizar tabs
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = '';
            const obcKeys = Object.keys(GLOBAL_STATE.tabs);

            obcKeys.forEach(obc => {
                const tabDiv = document.createElement('div');
                tabDiv.className = `tab ${obc === activeOBC ? 'active' : ''}`;
                tabDiv.innerHTML = `
                    ${obc}
                    ${obcKeys.length > 1 ? `<span class="tab-close" onclick="event.stopPropagation(); removeOBC('${obc}')">√ó</span>` : ''}
                `;
                tabDiv.onclick = () => switchOBC(obc);
                tabBar.appendChild(tabDiv);
            });

            const newTabBtn = document.createElement('div');
            newTabBtn.className = 'tab';
            newTabBtn.textContent = '+ Nueva OBC';
            newTabBtn.onclick = addOBC;
            newTabBtn.style.backgroundColor = 'var(--primary-color)';
            newTabBtn.style.color = 'white';
            tabBar.appendChild(newTabBtn);

            // Actualizar campos
            document.getElementById('active-user-display').value = tab.user;
            document.getElementById('active-obc-display').value = activeOBC;
            document.getElementById('global-location').value = tab.location;

            // Calcular estad√≠sticas
            const validatedCount = tab.validations.length;
            const rejectedCount = tab.rejections.filter(r => r.rejectionReason === 'NO_EXISTE_EN_BD').length;
            const totalScans = validatedCount + rejectedCount;
            const errorRate = totalScans > 0 ? ((rejectedCount / totalScans) * 100).toFixed(1) : '0.0';

            document.getElementById('validated-count').textContent = validatedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;
            document.getElementById('error-rate').textContent = `${errorRate}%`;

            // Renderizar lista de OBCs en sidebar
            renderOBCList();
            renderLogs();
        }

        function renderOBCList() {
            const obcList = document.getElementById('obc-list');
            obcList.innerHTML = '';

            for (const obc in GLOBAL_STATE.tabs) {
                const tab = GLOBAL_STATE.tabs[obc];
                const item = document.createElement('div');
                item.className = 'obc-list-item';
                item.innerHTML = `
                    <span>${obc}</span>
                    <span style="opacity: 0.7;">${tab.validations.length} ‚úì</span>
                `;
                obcList.appendChild(item);
            }
        }

        function renderLogs() {
            const activeOBC = GLOBAL_STATE.activeOBC;
            const tab = GLOBAL_STATE.tabs[activeOBC];
            const okLogsList = document.getElementById('ok-logs');
            const rejectLogsList = document.getElementById('reject-logs');

            okLogsList.innerHTML = '';
            rejectLogsList.innerHTML = '';

            // Logs OK
            tab.validations.slice(0, 10).forEach(log => {
                const item = document.createElement('li');
                item.className = 'log-item log-ok';
                item.innerHTML = `
                    <div class="log-info">
                        <div class="log-code">${log.extractedCode}</div>
                        <div class="log-meta">${log.timestamp} ‚Ä¢ ${log.location || 'Sin ubicaci√≥n'}</div>
                    </div>
                    <button class="btn-edit" onclick="showEditModal(${log.id}, '${activeOBC}')">‚úèÔ∏è</button>
                `;
                okLogsList.appendChild(item);
            });

            if (tab.validations.length === 0) {
                okLogsList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No hay validaciones a√∫n</li>';
            }

            // Logs Rechazo
            tab.rejections.slice(0, 10).forEach(log => {
                const item = document.createElement('li');
                item.className = 'log-item log-reject';
                const reasonDisplay = log.rejectionReason.replace(/_/g, ' ');
                item.innerHTML = `
                    <div class="log-info">
                        <div class="log-code">${log.extractedCode || log.codeScanned}</div>
                        <div class="log-meta">${log.timestamp} ‚Ä¢ ${reasonDisplay}</div>
                    </div>
                `;
                rejectLogsList.appendChild(item);
            });

            if (tab.rejections.length === 0) {
                rejectLogsList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No hay rechazos</li>';
            }
        }

        function populateUserSelect() {
            const select = document.getElementById('user-select');
            VALIDATORS.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
            select.value = GLOBAL_STATE.tabs[GLOBAL_STATE.activeOBC].user;
        }

        // ==================== POPUPS ====================
        function showErrorPopup(code, obc, reason) {
            document.getElementById('error-code').textContent = code;
            document.getElementById('error-obc').textContent = obc;
            document.getElementById('error-reason').textContent = reason.replace(/_/g, ' ');
            document.getElementById('error-popup').style.display = 'flex';
            document.getElementById('scanner-input').blur();
        }

        function closeErrorPopup() {
            document.getElementById('error-popup').style.display = 'none';
            document.getElementById('scanner-input').focus();
        }

        function showDuplicatePopup(code, obc, previousLog) {
            document.getElementById('dup-code').textContent = code;
            document.getElementById('dup-obc').textContent = obc;
            document.getElementById('dup-timestamp').textContent = previousLog.date + ' ' + previousLog.timestamp;
            document.getElementById('dup-user').textContent = previousLog.user;
            document.getElementById('dup-location').textContent = previousLog.location || 'N/A';
            document.getElementById('duplicate-popup').style.display = 'flex';
            document.getElementById('scanner-input').blur();
        }

        function showForcedNoteModal() {
            document.getElementById('duplicate-popup').style.display = 'none';
            document.getElementById('forced-note-modal').style.display = 'flex';
            document.getElementById('forced-note-input').value = '';
            document.getElementById('forced-note-input').focus();
        }

        function closeForcedNoteModal() {
            document.getElementById('forced-note-modal').style.display = 'none';
            document.getElementById('duplicate-popup').style.display = 'flex';
        }

        async function handleDuplicateAction(action) {
            document.getElementById('duplicate-popup').style.display = 'none';
            document.getElementById('forced-note-modal').style.display = 'none';
            document.getElementById('scanner-input').focus();

            if (!lastScannedCode) return;

            if (action === 'force') {
                const note = document.getElementById('forced-note-input').value.trim();
                const finalNote = `DUPLICADO FORZADO: ${note || 'Sin justificaci√≥n'}`;

                await handleValidationOK(
                    lastScannedCode.rawCode,
                    lastScannedCode.extracted,
                    lastScannedCode.extracted,
                    lastScannedCode.obc,
                    lastScannedCode.user,
                    lastScannedCode.location,
                    finalNote
                );
                showNotification('‚ö†Ô∏è Duplicado forzado registrado', 'warning');
            } else {
                showNotification('Escaneo ignorado', 'info');
            }

            lastScannedCode = null;
            renderApp();
        }

        function showEditModal(logId, obc) {
            const log = GLOBAL_STATE.tabs[obc].validations.find(v => v.id === logId);
            if (!log) return;

            const newLocation = prompt(`Editando ${log.extractedCode}\n\nNueva Ubicaci√≥n (actual: ${log.location || 'vac√≠a'}):`);
            if (newLocation === null) return;

            const newNote = prompt(`Editando ${log.extractedCode}\n\nNueva Nota (actual: ${log.note || 'vac√≠a'}):`);
            if (newNote === null) return;

            const shouldDelete = confirm("¬øDeseas ELIMINAR este registro?");

            if (shouldDelete) {
                const index = GLOBAL_STATE.tabs[obc].validations.indexOf(log);
                if (index > -1) {
                    GLOBAL_STATE.tabs[obc].validations.splice(index, 1);
                    showNotification('üóëÔ∏è Registro eliminado', 'info');
                }
            } else {
                log.location = newLocation.toUpperCase().trim();
                log.note = newNote.trim();
                showNotification('‚úèÔ∏è Registro actualizado', 'success');
            }

            renderLogs();
            saveState();
        }

        // ==================== AUDIO Y FEEDBACK ====================
        function playAudio(type) {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            gainNode.gain.value = 0.3;

            if (type === 'ok') {
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);
            } else if (type === 'error') {
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'duplicate') {
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);

                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    gain2.gain.value = 0.3;
                    osc2.frequency.setValueAtTime(600, audioContext.currentTime);
                    osc2.start();
                    osc2.stop(audioContext.currentTime + 0.15);
                }, 250);
            }
        }

        function flashInput(type) {
            const input = document.getElementById('scanner-input');
            input.classList.remove('flash-success', 'flash-error');
            
            setTimeout(() => {
                input.classList.add(type === 'success' ? 'flash-success' : 'flash-error');
            }, 10);

            setTimeout(() => {
                input.classList.remove('flash-success', 'flash-error');
            }, 300);
        }

        function showNotification(message, type = 'info') {
            // Notificaci√≥n simple con alert (mejorable con toast notifications)
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ==================== EXPORTACI√ìN ====================
        async function exportData() {
            const allLogs = [];
            const header = "Timestamp,Usuario,OBC,C√≥digo Original,C√≥digo Extra√≠do,Ubicaci√≥n,Nota\n";

            for (const obc in GLOBAL_STATE.tabs) {
                GLOBAL_STATE.tabs[obc].validations.forEach(log => {
                    const timestampString = new Date(log.id).toISOString();
                    allLogs.push([
                        timestampString,
                        log.user,
                        log.obc,
                        `"${log.originalCode.replace(/"/g, '""')}"`,
                        log.extractedCode,
                        log.location || '',
                        log.note || ''
                    ].join(','));
                });
            }

            const csvContent = header + allLogs.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `validaciones_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`üì• Exportadas ${allLogs.length} validaciones`, 'success');
            playAudio('ok');
        }
    </script>
</body>
</html>
